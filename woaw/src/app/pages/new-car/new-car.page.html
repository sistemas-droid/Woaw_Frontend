<ion-header *ngIf="esDispositivoMovil">
  <ion-toolbar class="ios-toolbar newcar-toolbar">
    <ion-buttons slot="start">
      <button class="btn-back-ios" (click)="regresar()">
        <ion-icon name="chevron-back-outline"></ion-icon>
      </button>

      <div class="perfil-header">
        <img src="/assets/icon/logo2.png" alt="Go Autos" class="logo" />
        <span class="titulo-ios">Publicar vehículo</span>
      </div>
    </ion-buttons>

    <ion-buttons slot="end">
      <ion-button class="btn-close-ios" (click)="regresar()">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<!-- NAV DESKTOP -->
<app-navbar *ngIf="!esDispositivoMovil"></app-navbar>

<ion-content [fullscreen]="true" class="newcar-bg">
  <section class="contenedor_espacio">
    <div class="encabezado-subida">
      <h1>Publica tu vehículo</h1>
      <p>Elige qué tipo es, llena los datos básicos y continúa con los detalles.</p>
    </div>

    <!-- CATEGORÍAS -->
    <div
      class="contenedor-categorias"
      #contenedorCategorias
      *ngIf="!mostrarCarComponent"
      [class.seleccion-activa]="esDispositivoMovil && !!seleccion"
    >
      <div
        *ngFor="let opcion of opciones"
        class="categoria-card"
        [class.activa]="opcion.tipo === seleccion && puedeActivar(opcion.tipo)"
        [class.desactivada]="opcion.proximamente || opcion.tipo === 'lote'"
        (click)="manejarClick(opcion)"
      >
        <div class="etiqueta-proximamente" *ngIf="opcion.proximamente">
          Próximamente
        </div>

        <div class="icono">
          <img [src]="opcion.icono" [alt]="opcion.label" />
          <div
            *ngIf="opcion.tipo === seleccion && puedeActivar(opcion.tipo)"
            class="check-icono"
          >
            ✔
          </div>
        </div>
        <div class="label">{{ opcion.label }}</div>
      </div>
    </div>

    <!-- FORM / COMPONENTES -->
    <div
      class="contenedor_form"
      *ngIf="seleccion === 'lote' || seleccion === 'auto' || seleccion === 'moto' || seleccion === 'camion' || seleccion === 'renta'"
    >
      <div *ngIf="!isLoggedIn && seleccion != 'lote'" class="mensaje-autenticacion">
        Para publicar y vender un vehículo, primero debes iniciar sesión o crear
        una cuenta.
        <button class="btn-acceso" (click)="irAInicio()">Acceder</button>
      </div>

      <!-- Año / Marca / Modelo -->
      <div
        *ngIf="
          !mostrarCarComponent &&
          isLoggedIn &&
          (seleccion === 'auto' ||
            seleccion === 'moto' ||
            seleccion === 'camion' ||
            seleccion === 'renta')
        "
        class="fila-inputs"
      >
        <!-- Año -->
        <div class="campo" *ngIf="seleccion !== 'renta'">
          <label for="anio"
            >Año <span class="requerido">*</span></label
          >

          <select
            id="anio"
            [(ngModel)]="anioSeleccionado"
            (change)="verificarAnio('select')"
          >
            <option disabled selected value="">Selecciona un año</option>
            <option *ngFor="let anio of listaAnios" [value]="anio">
              {{ anio }}
            </option>
            <option value="otro">Otro...</option>
          </select>

          <input
            *ngIf="mostrarInputOtroAnio"
            type="number"
            min="1800"
            max="2007"
            [(ngModel)]="anioManual"
            placeholder="Escribe el año"
            class="input-otro-anio"
            (input)="verificarAnio('escrito')"
          />
          <p *ngIf="mostrarInputOtroAnio && mansaje_error !== ''" class="error_msj">
            {{ mansaje_error }}
          </p>
        </div>

        <!-- Marca -->
        <div class="campo">
          <label for="marca"
            >Marca <span class="requerido">*</span></label
          >

          <select
            id="marca"
            *ngIf="!marcaEsPersonalizada"
            [(ngModel)]="marcaSeleccionada"
            (change)="obtenerModelosSiCorresponde()"
            [disabled]="seleccion !== 'renta' && !anioValido"
          >
            <option disabled selected value="">Selecciona una marca</option>
            <option
              *ngFor="let marca of marcas"
              [value]="(seleccion === 'auto' || seleccion === 'renta') ? marca.key : marca._id"
            >
              {{ marca.nombre }}
            </option>
            <option value="otro">Otra marca...</option>
          </select>

          <input
            *ngIf="marcaEsPersonalizada"
            type="text"
            [(ngModel)]="marcaSeleccionada"
            (change)="obtenerModelosSiCorresponde()"
            placeholder="Escribe la marca"
            class="input-personalizado"
            maxlength="25"
          />
        </div>

        <!-- Modelo -->
        <div class="campo">
          <label for="modelo"
            >Modelo <span class="requerido">*</span></label
          >

          <!-- RENTA -->
          <select
            *ngIf="seleccion === 'renta' && !modeloEsPersonalizado"
            id="modelo"
            [(ngModel)]="modeloSeleccionado"
            (change)="selecionarModelo()"
            [disabled]="!marcaSeleccionada"
          >
            <option disabled selected value="">Selecciona un modelo</option>
            <option
              *ngFor="let modelo of modelos"
              [value]="modelo?.modelo || modelo?.nombre"
            >
              {{ modelo?.modelo || modelo?.nombre }}
            </option>
            <option value="otro">Otro modelo...</option>
          </select>

          <input
            *ngIf="seleccion === 'renta' && modeloEsPersonalizado"
            type="text"
            [(ngModel)]="modeloSeleccionado"
            (blur)="validarInputModelo()"
            placeholder="Escribe el modelo manualmente"
            class="input-personalizado"
            maxlength="25"
          />

          <!-- NO RENTA -->
          <input
            *ngIf="seleccion !== 'renta' && esAnioAnteriorA2008()"
            type="text"
            id="modelo"
            [(ngModel)]="modeloSeleccionado"
            (change)="selecionarModelo()"
            placeholder="Escribe el modelo"
            maxlength="25"
          />

          <select
            *ngIf="seleccion !== 'renta' && !esAnioAnteriorA2008() && !modeloEsPersonalizado"
            id="modelo"
            [(ngModel)]="modeloSeleccionado"
            (change)="selecionarModelo()"
            [disabled]="!marcaSeleccionada"
          >
            <option disabled selected value="">Selecciona un modelo</option>
            <option
              *ngFor="let modelo of modelos"
              [value]="(seleccion === 'auto') ? modelo.modelo : modelo.nombre"
            >
              {{ (seleccion === 'auto') ? modelo.modelo : modelo.nombre }}
            </option>
            <option value="otro">Otro modelo...</option>
          </select>

          <input
            *ngIf="seleccion !== 'renta' && modeloEsPersonalizado"
            type="text"
            [(ngModel)]="modeloSeleccionado"
            (blur)="validarInputModelo()"
            placeholder="Escribe el modelo manualmente"
            class="input-personalizado"
            maxlength="25"
          />
        </div>
      </div>

      <!-- CONTINUAR -->
      <button
        [disabled]="!formularioValido()"
        *ngIf="
          !mostrarCarComponent &&
          isLoggedIn &&
          (seleccion === 'auto' ||
            seleccion === 'moto' ||
            seleccion === 'renta' ||
            seleccion === 'camion')
        "
        class="btn-guardar"
        (click)="mostrarComponente()"
      >
        Continuar
        <ion-icon name="arrow-forward-outline"></ion-icon>
      </button>

      <!-- HEADER DEL COMPONENTE -->
      <div *ngIf="mostrarCarComponent" class="fila_select">
        <button type="button" class="btn-regresar-ios" (click)="volverAtras()">
          <ion-icon name="chevron-back-outline" class="icono-regresar"></ion-icon>
          Regresar
        </button>
        <div class="seleccion-info">
          <img [src]="mostrarIcono" alt="icono seleccionado" />
          <p>{{ mostrarSelecion }}</p>
        </div>
      </div>

      <!-- COMPONENTES -->
      <app-car
        *ngIf="mostrarCarComponent && seleccion === 'auto'"
        [anio]="obtenerAnioActual()"
        [marca]="marcaSeleccionada"
        [modelo]="modeloSeleccionado"
        [tipo]="seleccion"
      ></app-car>

      <app-motos
        *ngIf="mostrarCarComponent && seleccion === 'moto'"
        [anio]="obtenerAnioActual()"
        [marca]="getMarcaNombreSeleccionada()"
        [modelo]="modeloSeleccionado"
        [tipo]="seleccion"
      ></app-motos>

      <app-renta
        *ngIf="mostrarCarComponent && seleccion === 'renta'"
        [anio]="0"
        [marca]="marcaSeleccionada"
        [modelo]="modeloSeleccionado"
        [tipo]="seleccion"
        (rentaSubmit)="registrarRenta($event)"
      ></app-renta>

      <app-camion
        *ngIf="mostrarCarComponent && seleccion === 'camion'"
        [anio]="obtenerAnioActual()"
        [marca]="getMarcaNombreSeleccionada()"
        [modelo]="modeloSeleccionado"
        [tipo]="seleccion"
      ></app-camion>

      <app-add *ngIf="mostrarCarComponent && seleccion === 'lote'"></app-add>
    </div>
  </section>

</ion-content>
