<app-navbar></app-navbar>

<ion-content [fullscreen]="true" class="ios-poliza-detalle">
  <app-spinner *ngIf="mostrar_spinnet"></app-spinner>
  <app-otros-seguros [refreshKey]="islandKey" *ngIf="tipoDispocitivo === 'telefono'"></app-otros-seguros>


  <div class="fondo-seguros">
    <img src="/assets/autos/seguro_fondo.webp" alt="">
    <span class="fondo-seguros__overlay"></span>
  </div>

  <div class="split-woaw-seguros" style="--left: 80%; --right: 20%; --gap: 1px;">

    <div class="divicion1">

      <div class="poliza" *ngIf="isLoggedIn">
        <section class="poliza__card">

          <ng-container *ngIf="!polizaCreada">
            <div class="header">
              <h1>Crear p√≥liza</h1>
            </div>

            <form [formGroup]="form_poliza">

              <ion-grid>
                <ion-row>
                  <ion-col size="12" size-md="8">
                    <div class="field field-grid">
                      <!-- VIN -->
                      <div>
                        <label for="vin">
                          VIN del auto <span>*</span>
                        </label>
                        <div class="control">
                          <input id="vin" type="text" class="form-input" placeholder="XX17XFSF" formControlName="vin"
                            maxlength="17" (input)="onVinInput($event)" />
                        </div>
                        <p *ngIf="analizaForm('vin')" class="error">El VIN es obligatorio</p>
                      </div>

                      <!-- Placas -->
                      <div>
                        <label for="placas">
                          Placas del auto <span>*</span>
                        </label>
                        <div class="toggle-container">
                          <ion-toggle [(ngModel)]="placasEnTramite" [ngModelOptions]="{ standalone: true }"
                            (ionChange)="togglePlacasTramite()">
                          </ion-toggle>
                          <span>Placas en tr√°mite</span>
                        </div>

                        <div class="control">
                          <input id="placas" type="text" class="form-input" placeholder="UQTWRBS"
                            formControlName="placas" maxlength="7" [readonly]="placasEnTramite"
                            (input)="onPlacasInput($event)" />
                        </div>
                        <p *ngIf="analizaForm('placas')" class="error">Las placas son obligatorias</p>
                      </div>

                      <!-- Color -->
                      <div>
                        <label for="color">
                          Color del auto <span>*</span>
                        </label>
                        <div class="control">
                          <select id="color" class="form-input" formControlName="color">
                            <option value="" disabled selected>Selecciona un color</option>
                            <option *ngFor="let opt of colorOpts" [value]="opt.value">
                              {{ opt.label }}
                            </option>
                          </select>
                        </div>
                        <p *ngIf="analizaForm('color')" class="error">
                          El color es obligatorio
                        </p>
                      </div>

                      <!-- Plan de pago -->
                      <div>
                        <label for="pago">
                          Selecciona tu plan <span>*</span>
                        </label>
                        <div class="control">
                          <!-- En tu template -->
                          <ion-select [(ngModel)]="selectedPaymentId" (ionChange)="onSelectPayment($event.detail.value)"
                            interface="popover" placeholder="Selecciona tu plan de pago" formControlName="pago">

                            <ion-select-option
                              *ngFor="let plan of (datoscotizacion?.plans?.[0]?.discount?.payment_plans || datoscotizacion?.plans?.[0]?.payment_plans || [])"
                              [value]="plan.id">
                              {{ paymentPlanLabel(plan) }} ‚Äî {{ fmtMoney(plan.total) }}
                            </ion-select-option>
                          </ion-select>
                        </div>
                      </div>
                    </div>

                  </ion-col>

                  <ion-col size="12" size-md="4">
                    <div class="cal">
                      <div class="cal__head">
                        <button class="cal__nav" (click)="calInitOrChange(-1)" [disabled]="!_calCanPrev"
                          aria-label="Mes anterior">
                          <ion-icon name="chevron-back-outline"></ion-icon>
                        </button>
                        <div class="cal__title">{{ _calHeader }}</div>
                        <button class="cal__nav" (click)="calInitOrChange(1)" [disabled]="!_calCanNext"
                          aria-label="Mes siguiente">
                          <ion-icon name="chevron-forward-outline"></ion-icon>
                        </button>
                      </div>

                      <div class="cal__grid cal__dow">
                        <div>Lun</div>
                        <div>Mar</div>
                        <div>Mi√©</div>
                        <div>Jue</div>
                        <div>Vie</div>
                        <div>S√°b</div>
                        <div>Dom</div>
                      </div>

                      <div class="cal__grid">
                        <ng-container *ngFor="let wk of _calWeeks">
                          <ng-container *ngFor="let c of wk">
                            <button class="cal__cell" [class.is-outside]="c.outside" [class.is-today]="c.today"
                              [class.is-selected]="c.selected" [disabled]="c.disabled || !c.date"
                              (click)="_calPick(c.date)">
                              <span *ngIf="c.date">{{ c.date | date:'d' }}</span>
                            </button>
                          </ng-container>
                        </ng-container>
                      </div>

                      <div class="cal__foot" *ngIf="_startDateISO">
                        <ion-icon name="calendar-outline"></ion-icon>
                        <span>Inicio: {{ _startDateISO | date:'EEEE d \'de\' MMMM, y':'':'es-MX' }}</span>
                      </div>
                    </div>

                    <!-- Correos din√°micos -->
                    <div class="field field-grid">
                      <label>
                        <ion-icon name="mail-outline"></ion-icon>
                        Correos de contacto (opcional)
                      </label>

                      <div formArrayName="correos">
                        <div class="correo-item" *ngFor="let ctrl of correos.controls; let i = index;">
                          <div class="control">
                            <input class="form-input" type="email" [formControlName]="i"
                              placeholder="correo@ejemplo.com" inputmode="email" autocomplete="email"
                              (input)="normalizeCorreo(i)" />
                          </div>
                          <button type="button" class="btn-ghost danger" (click)="removeCorreo(i)"
                            aria-label="Eliminar correo">
                            <ion-icon name="trash"></ion-icon>
                          </button>
                          <p *ngIf="ctrl.invalid && (ctrl.dirty || ctrl.touched)" class="error">
                            {{ getCorreoError(ctrl.errors) }}
                          </p>
                        </div>
                      </div>

                      <div class="correos-actions">
                        <button type="button" class="btn-outline" (click)="addCorreo()" [disabled]="!canAddCorreo">
                          <ion-icon name="add-circle-outline"></ion-icon>
                          Agregar correo <small *ngIf="correos.length>0">({{correos.length}}/2)</small>
                        </button>
                      </div>

                      <p *ngIf="correos.hasError('duplicated') && (correos.dirty || correos.touched)" class="error">
                        No repitas el mismo correo.
                      </p>
                    </div>
                  </ion-col>

                </ion-row>
              </ion-grid>

              <!-- CTA -->
              <div class="paybox__cta" *ngIf="tipoDispocitivo !== 'telefono'">
                <button type="button" class="btn-secondary" (click)="regresarPage()">
                  <ion-icon name="arrow-back-outline"></ion-icon>
                  Regresar
                </button>
                <button type="submit" class="btn-primary" (click)="siguiente()">
                  Siguiente <ion-icon name="arrow-forward-outline"></ion-icon>
                </button>
              </div>

            </form>

          </ng-container>

          <ng-container *ngIf="polizaCreada && datosPolizaCreada as d">
            <section class="poliza_creada">
              <ion-grid class="poliza-grid">
                <ion-row class="ion-align-items-stretch">

                  <!-- IZQUIERDA (m√°s grande) -->
                  <ion-col size="12" sizeMd="7">
                    <div class="poliza__hero">
                      <div class="poliza__msg">
                        <ion-icon name="checkmark-circle"></ion-icon>
                        <h2>P√≥liza creada.</h2>
                        <p>
                          Hemos enviado la informaci√≥n de tu p√≥liza a tu correo electr√≥nico
                          <strong>{{ email }}üìß</strong>.
                          <br /><br />
                          Revisa tu bandeja de entrada para descargar tus documentos digitales.
                        </p>
                      </div>

                      <button class="bt_paga" (click)="realizarPago()">
                        <ion-icon name="cash-outline"></ion-icon>
                        Realizar pago
                      </button>

                      <button class="bt_regresar_r" (click)="regresar()">
                        &#x2B05; Realizar nueva cotizac√≥n
                      </button>
                    </div>
                  </ion-col>

                  <!-- DERECHA (compacta) -->
                  <ion-col size="12" sizeMd="5">
                    <div class="poliza__sidecard">
                      <div class="folio">
                        <span>Folio</span>
                        <strong>{{ folioCO || '‚Äî' }}</strong>
                      </div>

                      <ul class="vigencia" *ngIf="inicioVigencia || finVigencia">
                        <li *ngIf="inicioVigencia"><b>Inicio:</b> {{ inicioVigencia }}</li>
                        <li *ngIf="finVigencia"><b>Fin:</b> {{ finVigencia }}</li>
                      </ul>

                      <div class="files-actions">
                        <a *ngIf="invoiceUrl" class="bt_pdf" [href]="invoiceUrl" target="_blank" rel="noopener"
                          download>
                          <ion-icon name="document-text-outline"></ion-icon>
                          Descargar Recibo (PDF)
                        </a>

                        <a *ngIf="coverUrl" class="bt_pdf" [href]="coverUrl" target="_blank" rel="noopener" download>
                          <ion-icon name="document-outline"></ion-icon>
                          Descargar P√≥liza (PDF)
                        </a>
                      </div>
                    </div>
                  </ion-col>

                </ion-row>
              </ion-grid>
            </section>
          </ng-container>
        </section>
      </div>

      <div class="carta-login" *ngIf="!isLoggedIn">

        <div class="contenedor_texto">
          <h2>¬°√öltimo paso!</h2>
          <p>
            Crea tu perfil o inicia sesi√≥n para guardar tu cotizaci√≥n, generar tu p√≥liza y envi√°rtela al instante.
            Tu informaci√≥n est√° protegida con los m√°s altos est√°ndares de seguridad.
          </p>
        </div>

        <div class="container_vidrio">
          <app-login *ngIf="MostrarLogin && !MostrarRecuperacion && !MostrarRegistro"></app-login>
          <app-registro *ngIf="!MostrarLogin && !MostrarRecuperacion && MostrarRegistro"></app-registro>
          <app-resetpassword *ngIf="!MostrarLogin && MostrarRecuperacion && !MostrarRegistro"></app-resetpassword>
          <p class="link-registro">
            <span *ngIf="MostrarLogin && !MostrarRecuperacion && !MostrarRegistro">¬øNo tienes una cuenta? </span>
            <span *ngIf="!MostrarLogin">¬øYa tienes cuenta? </span>
            <strong>
              <span (click)="cambioEstatus('registro')"
                *ngIf="MostrarLogin && !MostrarRecuperacion && !MostrarRegistro">Registrarme</span>
              <span (click)="cambioEstatus('login')" *ngIf="!MostrarLogin">Iniciar Sesi√≥n</span>
            </strong>
          </p>
          <p class="link-registro" *ngIf="!MostrarRecuperacion">
            <strong (click)="cambioEstatus('reset')">
              <ion-icon name="lock-closed-outline" style="vertical-align: middle; margin-right: 6px;"></ion-icon>
              ¬øOlvidaste tu contrase√±a?
            </strong>
          </p>
          <!-- L√≠nea de separaci√≥n -->
          <div *ngIf="MostrarLogin" style="width: 100%; height: 1px; background-color: #ccc; margin: 16px 0;"></div>
          <p class="link-registro" *ngIf="MostrarLogin">
            Acepto las
            <a class="enlace-politica" (click)="mostrarTerminos()">T√©rminos y condiciones</a> y el
            <a class="enlace-politica" (click)="mostrarAviso()">Aviso de Privacidad</a>.
          </p>
        </div>

      </div>

    </div>
    <div class="divicion2">
      <app-otros-seguros *ngIf="tipoDispocitivo !== 'telefono'" [refreshKey]="islandKey"></app-otros-seguros>
    </div>

  </div>
  <br *ngIf="tipoDispocitivo === 'telefono'">
  <br *ngIf="tipoDispocitivo === 'telefono'">
  <br *ngIf="tipoDispocitivo === 'telefono'">
  <br *ngIf="tipoDispocitivo === 'telefono'">
  <br *ngIf="tipoDispocitivo === 'telefono'">
  <br *ngIf="tipoDispocitivo === 'telefono'">
  <br *ngIf="tipoDispocitivo === 'telefono'">

  <app-footer *ngIf="tipoDispocitivo !== 'telefono'"></app-footer>
</ion-content>

<ion-footer class="safe-footer footer_css_seguros" *ngIf="tipoDispocitivo === 'telefono'">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button fill="clear" (click)="regresarPage()">
        <ion-icon slot="start" name="arrow-back-outline"></ion-icon>
        Atr√°s
      </ion-button>
    </ion-buttons>

    <ion-buttons slot="end">
      <ion-button color="danger" fill="solid" type="submit" (click)="siguiente()">
        Continuar
        <ion-icon slot="end" name="arrow-forward-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-footer>