<app-navbar></app-navbar>

<ion-content [fullscreen]="true">

  <app-spinner *ngIf="mostrar_spinner" [tipo]="tipo_spinner" [text]="texto_spinner" [sub_text]="textoSub_spinner"></app-spinner>
  <app-otros-seguros [refreshKey]="islandKey" *ngIf="tipoDispocitivo === 'telefono'"></app-otros-seguros>

  <div class="fondo-seguros">
    <img src="/assets/autos/seguro_fondo.webp" alt="">
    <span class="fondo-seguros__overlay"></span>
  </div>

  <div class="split-woaw-seguros" style="--left: 80%; --right: 20%; --gap: 1px;">

    <div class="divicion1">

      <div class="layout-seguros" *ngIf="!cotizacion">

        <div class="cotiza">
          <section class="cotiza__card" [ngClass]="{ 'is-step1': currentStep === 1 }">

            <header class="cotiza__head">
              <span class="badge">Seguro de auto ¬∑ Woaw</span>
              <h1>Comienza tu cotizaci√≥n personalizada</h1>

              <div class="progress" *ngIf="!quote" [ngClass]="{ 'is-step1': currentStep === 1 }">
                <div class="progress__bar" [style.width.%]="progress()"></div>
                <div class="progress__markers">
                  <span *ngFor="let step of steps; let i = index" [style.left.%]="(100 / (steps.length - 1)) * i"
                    [class.done]="i + 1 < currentStep" [class.active]="i + 1 === currentStep">
                    {{ step }}
                  </span>
                </div>
              </div>
            </header>

            <form [formGroup]="form">

              <div class="field" *ngIf="currentStep === 1">
                <div class="marca-picker" role="listbox" aria-label="Selecciona una marca">
                  <!-- <div class="marca-picker__label">Selecciona una marca</div> -->

                  <div class="marca-picker__search">
                    <ion-searchbar placeholder="Buscar marca‚Ä¶" [debounce]="150"
                      (ionInput)="onSearchBrand($event.detail.value)">
                    </ion-searchbar>
                  </div>

                  <div class="marca-picker__grid">
                    <button type="button" class="marca-picker__card marca-picker__card--other" role="option"
                      aria-selected="false" (click)="selectOtherBrand()">
                      <div class="marca-picker__icon--other">
                        <ion-icon name="add-circle-outline" aria-hidden="true"></ion-icon>
                      </div>
                      <div class="marca-picker__name--other">Otra marca</div>
                    </button>

                    <button type="button" class="marca-picker__card" *ngFor="let b of brandsVM"
                      [class.is-selected]="isSelected(b.id)" role="option" [attr.aria-selected]="isSelected(b.id)"
                      (click)="selectBrand(b.id)">
                      <div class="marca-picker__icon">
                        <img *ngIf="b.imageUrl; else noimg" [src]="b.imageUrl" [alt]="b.name" loading="lazy" />
                        <ng-template #noimg>
                          <span class="marca-picker__fallback">{{ b.name | titlecase }}</span>
                        </ng-template>
                      </div>
                      <div class="marca-picker__name">{{ b.name | titlecase }}</div>
                    </button>
                  </div>

                </div>
              </div>

              <ng-container *ngIf="currentStep === 2">

                <div class="field">
                  <label for="modelo">Selecciona el modelo <span>*</span> </label>
                  <div class="control control--select">
                    <ion-select #lista class="sync-pop" formControlName="modelo" interface="popover" aria-label="Modelo"
                      [interfaceOptions]="{ cssClass: 'select-popover pop-modelo', side: 'bottom', alignment: 'start' }"
                      placeholder="Elige un modelo..." data-key="modelo" (ionFocus)="syncPopoverWidths()"
                      (ionChange)="onModeloSeleccionado($event)">
                      <ion-select-option [value]="null" disabled>Elige un modelo...</ion-select-option>
                      <ion-select-option *ngFor="let mo of modelos" [value]="mo.id">
                        {{ mo.name | titlecase }}
                      </ion-select-option>
                    </ion-select>
                  </div>
                </div>

                <div class="field">
                  <label for="anio">Selecciona el a√±o <span>*</span></label>
                  <div class="control control--select">

                    <ion-select #lista class="sync-pop" formControlName="anio" interface="popover"
                      placeholder="Elige un a√±o..." aria-label="anio"
                      [interfaceOptions]="{ cssClass: 'select-popover pop-anio', side: 'bottom', alignment: 'start' }"
                      data-key="anio" (ionFocus)="syncPopoverWidths()" (ionChange)="onAnioSeleccionado($event)">

                      <ion-select-option [value]="null" disabled>Elige un a√±o...</ion-select-option>
                      <ion-select-option *ngFor="let y of anios" [value]="y">
                        {{ y }}
                      </ion-select-option>
                    </ion-select>
                  </div>
                </div>

                <div class="field">
                  <label for="version">Selecciona la versi√≥n <span>*</span></label>
                  <div class="control control--select">

                    <ion-select #lista class="sync-pop" formControlName="version" interface="popover"
                      placeholder="Elige una versi√≥n..." aria-label="Versi√≥n"
                      [interfaceOptions]="{ cssClass: 'select-popover pop-version', side: 'bottom', alignment: 'start' }"
                      data-key="version" (ionFocus)="syncPopoverWidths()">

                      <ion-select-option [value]="null" disabled>Elige una versi√≥n...</ion-select-option>
                      <ion-select-option *ngFor="let v of versions" [value]="v.id">
                        {{ v.parts | titlecase }}
                      </ion-select-option>
                    </ion-select>
                  </div>
                </div>

              </ng-container>

              <div class="field" *ngIf="currentStep === 3">
                <label>Fecha de nacimiento <span>*</span></label>

                <div class="fecha-flex">
                  <div class="control control--select">

                    <ion-select #lista class="sync-pop" formControlName="nacDia" interface="popover" placeholder="D√≠a"
                      aria-label="D√≠a"
                      [interfaceOptions]="{ cssClass: 'select-popover pop-nacDia', side: 'bottom', alignment: 'start' }"
                      data-key="nacDia" (ionFocus)="syncPopoverWidths()">

                      <ion-select-option [value]="null" disabled>D√≠a</ion-select-option>
                      <ion-select-option *ngFor="let d of dias" [value]="d">
                        {{ d }}
                      </ion-select-option>
                    </ion-select>
                  </div>

                  <div class="control control--select">

                    <ion-select #lista class="sync-pop" formControlName="nacMes" interface="popover" placeholder="Mes"
                      aria-label="Mes"
                      [interfaceOptions]="{ cssClass: 'select-popover pop-nacMes', side: 'bottom', alignment: 'start' }"
                      data-key="nacMes" (ionFocus)="syncPopoverWidths()">
                      <ion-select-option [value]="null" disabled>Mes</ion-select-option>
                      <ion-select-option *ngFor="let m of meses" [value]="m.v">
                        {{ m.l }}
                      </ion-select-option>
                    </ion-select>
                  </div>

                  <div class="control control--select">

                    <ion-select #lista class="sync-pop" formControlName="nacAnio" interface="popover" placeholder="A√±o"
                      aria-label="A√±o"
                      [interfaceOptions]="{ cssClass: 'select-popover pop-nacAnio', side: 'bottom', alignment: 'start' }"
                      data-key="nacAnio" (ionFocus)="syncPopoverWidths()">

                      <ion-select-option [value]="null" disabled>A√±o</ion-select-option>
                      <ion-select-option *ngFor="let y of aniosNacimiento" [value]="y">
                        {{ y }}
                      </ion-select-option>
                    </ion-select>
                  </div>
                </div>
              </div>

              <div class="field" *ngIf="currentStep === 4">

                <label for="genero" style="margin-top:12px;">G√©nero <span>*</span></label>
                <div class="control control--select">

                  <ion-select #lista class="sync-pop" formControlName="genero" interface="popover"
                    placeholder="Selecciona..." aria-label="G√©nero"
                    [interfaceOptions]="{ cssClass: 'select-popover pop-genero', side: 'bottom', alignment: 'start' }"
                    data-key="genero" (ionFocus)="syncPopoverWidths()" (ionChange)="checkEnableCP($event)">

                    <ion-select-option [value]="null" disabled>Selecciona...</ion-select-option>
                    <ion-select-option *ngFor="let g of generoOpts" [value]="g.value">
                      {{ g.label }}
                    </ion-select-option>
                  </ion-select>
                </div>

                <label for="estadoCivil" style="margin-top:12px;">Estado civil <span>*</span></label>
                <div class="control control--select">
                  <ion-select formControlName="estadoCivil" interface="popover" placeholder="Selecciona..."
                    aria-label="Estado civil"
                    [interfaceOptions]="{ cssClass: 'select-popover pop-estadoCivil', side: 'bottom', alignment: 'start' }"
                    data-key="estadoCivil" (ionFocus)="syncPopoverWidths()" (ionChange)="checkEnableCP($event)">
                    <ion-select-option [value]="null" disabled>Selecciona...</ion-select-option>
                    <ion-select-option *ngFor="let e of estadoCivilOpts" [value]="e.value">
                      {{ e.label }}
                    </ion-select-option>
                  </ion-select>
                </div>

                <label for="cp" style="margin-top:12px;">C√≥digo Postal <span>*</span></label>
                <div class="control">
                  <input id="cp" type="text" class="form-input" maxlength="5" placeholder="Ej. 76000"
                    formControlName="cp" />
                </div>

              </div>

              <div class="field" *ngIf="currentStep === 5">
                <label>Verifica tu informaci√≥n <span>*</span></label>

                <div class="summary">
                  <div class="summary__row">
                    <span class="k">Marca</span><span class="v">{{ getMarcaLabel() }}</span>
                  </div>
                  <div class="summary__row">
                    <span class="k">Modelo</span><span class="v">{{ getModeloLabel() }}</span>
                  </div>
                  <div class="summary__row">
                    <span class="k">A√±o</span><span class="v">{{ form.get('anio')?.value }}</span>
                  </div>
                  <div class="summary__row">
                    <span class="k">Versi√≥n</span><span class="v">{{ getVersionLabel() }}</span>
                  </div>
                  <div class="summary__row">
                    <span class="k">Nacimiento</span><span class="v">{{ getNacimiento() }}</span>
                  </div>
                  <div class="summary__row">
                    <span class="k">C.P.</span><span class="v">{{ form.get('cp')?.value }}</span>
                  </div>
                  <div class="summary__row">
                    <span class="k">G√©nero</span><span class="v">{{ getGeneroLabel() }}</span>
                  </div>
                  <div class="summary__row">
                    <span class="k">Estado civil</span><span class="v">{{ getEstadoCivilLabel() }}</span>
                  </div>
                </div>

              </div>

              <div class="paybox__cta" *ngIf="tipoDispocitivo !== 'telefono'">
                <button type="button" *ngIf="currentStep !== 1" class="btn-secondary"
                  (click)="ClearRegrasar()">&#x2B05;</button>
                <button class="btn-primary" type="button" (click)="siguiente()" [disabled]="
                  (currentStep===1 && form.get('marca')?.invalid) ||
                  (currentStep===2 && (form.get('modelo')?.invalid || form.get('anio')?.invalid || form.get('version')?.invalid)) ||
                  (currentStep===3 && form.get('nacDia')?.invalid || form.get('nacMes')?.invalid || form.get('nacAnio')?.invalid) ||
                  (currentStep===4 && (form.get('cp')?.invalid || form.get('genero')?.invalid || form.get('estadoCivil')?.invalid))
                  ">
                  {{ currentStep < 5 ? 'Siguiente ' : 'Cotizar' }} &#x27A1; </button>
              </div>

            </form>
          </section>

        </div>

      </div>

      <section class="quote-pro" *ngIf="quote as q">

        <!-- Topbar con estado -->
        <header class="qp-head">
          <div class="qp-head__title">
            <h1>Tu cotizaci√≥n est√° lista</h1>
            <p>Revisa el detalle y contin√∫a con la contrataci√≥n.</p>
          </div>
          <div class="qp-head__ok" aria-label="Cotizaci√≥n v√°lida">
            <span class="ring"></span>
            <img src="/assets/img/check.png" alt="ok">
          </div>
        </header>

        <!-- Faja de resumen (chips) -->
        <section class="qp-badgebar">
          <span class="chip">
            {{ q.vehicle?.brand?.name | titlecase }}
            {{ q.vehicle?.model?.name | titlecase }}
            {{ q.vehicle?.year?.name }}
          </span>
          <span class="chip alt" *ngIf="q.vehicle?.version?.name as ver">{{ ver | titlecase }}</span>
          <span class="chip">CP {{ q.region?.postal_code }}</span>
          <span class="chip" *ngIf="q.region?.state?.name">{{ q.region?.state?.name }}</span>
          <span class="chip alt" *ngIf="q.duration">{{ q.duration }} meses</span>
          <span class="chip ok" *ngIf="q.coupon">
            Cup√≥n: {{ q.coupon }}
            <button *ngIf="cuponExistente" class="btn-remove-cupon" (click)="removerCuponExistente()"
              aria-label="Eliminar cup√≥n">
              <ion-icon name="trash"></ion-icon>
            </button>
          </span>
        </section>

        <!-- Grid principal -->
        <section class="qp-grid">

          <div class="qp-left" *ngIf="q.plans?.length">

            <article class="qp-amount" *ngIf="q.plans[0] as p">
              <header>
                <h2>Monto estimado</h2>
                <small>Plan seleccionado</small>
                <!-- Mostrar mensaje de descuento si existe -->
                <div *ngIf="p.discount?.marketing_text?.default" class="discount-message">
                  üéâ {{ p.discount.marketing_text.default }}
                </div>
              </header>
              <div class="price" *ngIf="getSelectedPayment(p) as sel">
                <!-- parte 1 -->
                <div class="price__info">
                  <ng-container *ngIf="paymentSummary(sel) as s">
                    <div class="price__total">{{ fmtMoney(s.total) }}</div>
                    <div class="price__note" *ngIf="s.isOneShot">Pago √∫nico</div>
                    <div class="price__note" *ngIf="!s.isOneShot && s.variable">
                      1er pago <strong>{{ fmtMoney(s.first) }}</strong> <br> {{ s.restCount }} pagos de <strong>{{
                        fmtMoney(s.rest) }}</strong>
                    </div>
                    <div class="price__note" *ngIf="!s.isOneShot && !s.variable">
                      {{ s.count }} pagos de <strong>{{ fmtMoney(s.per) }}</strong>
                    </div>
                  </ng-container>
                </div>

                <!-- parte 2 -->
                <div class="input_cupon">
                  <div class="control control--select" style="margin-top: -5px;">
                    <ion-select #lista class="sync-pop" id="paySel" [(ngModel)]="selectedPaymentByPlan[p.id]"
                      (ionChange)="onSelectPayment(p.id)" interface="popover" aria-label="Plan de pago">
                      <!-- REMOVED: placeholder="Elige un plan‚Ä¶" -->
                      <ion-select-option
                        *ngFor="let opt of (p.discount?.payment_plans || p.payment_plans); trackBy: trackByPayment"
                        [value]="opt.id">
                        {{ paymentPlanLabel(opt) }} ‚Äî {{ fmtMoney(opt.total) }}
                      </ion-select-option>
                    </ion-select>
                  </div>
                </div>

              </div>

              <div class="divider"></div>

              <!-- Selector de plan -->
              <div class="plan-picker">

                <div class="input_cupon">
                  <div class="field">
                    <div class="control">

                      <input id="cupon" type="text" class="form-input" placeholder="Ingresa tu cup√≥n"
                        [(ngModel)]="cupon" maxlength="20" (input)="validarCupon()" [class.invalid]="cuponInvalido" />
                      <button class="btn_seearch_cupon" type="button" (click)="aplicarCupon()">
                        Aplicar
                      </button>

                    </div>
                    <div *ngIf="cuponInvalido" class="error_messages">
                      <small class="error">{{ mensajeErrorCupon }}</small>
                    </div>
                  </div>
                </div>

              </div>

              <!-- Desglose compacto -->
              <ul class="breakdown" *ngIf="getSelectedPayment(p) as pay">
                <ng-container *ngIf="planInfo(pay) as i">
                  <li>
                    <span>Prima neta</span><b>{{ fmtMoney(i.net_premium) }}</b>
                  </li>
                  <li>
                    <span>Derechos (expedici√≥n)</span><b>{{ fmtMoney(i.expedition_rights) }}</b>
                  </li>
                  <li *ngIf="i.fee">
                    <span>Comisi√≥n / recargos</span><b>{{ fmtMoney(i.fee) }}</b>
                  </li>
                  <li class="muted">
                    <span>Subtotal</span><b>{{ fmtMoney(i.subtotal) }}</b>
                  </li>
                  <li class="muted">
                    <span>IVA</span><b>{{ fmtMoney(i.taxes) }}</b>
                  </li>
                  <li class="strong">
                    <span>Total</span><b>{{ fmtMoney(i.total) }}</b>
                  </li>
                </ng-container>
              </ul>
            </article>

            <!-- CTA card -->
            <article class="qp-cta" *ngIf="tipoDispocitivo !== 'telefono'">
              <button type="button" class="btn ghost" (click)="nuevoSeguro()">Nueva cotizacion ‚Üª</button>

              <button type="button" class="btn secondary" (click)="previsualizarPDF()">
                <ion-icon name="document-outline" slot="start"></ion-icon>
                PDF
              </button>

              <button type="button" class="btn prime" (click)="confirmarCrearPersona()">Continuar ‚ûú</button>
            </article>

            <!-- <article class="pdf-preview-auto" *ngIf="pdfUrl">
              <header>
                <h3>Cotizaci√≥n Woaw Seguros</h3>
                <small>Vista previa del documento</small>
              </header>
              <div class="pdf-preview-content">
                <iframe [src]="pdfUrl" width="100%" height="500" style="border: 1px solid #e0e0e0; border-radius: 8px;"
                  title="Vista previa de la cotizaci√≥n">
                </iframe>
              </div>
            </article> -->

          </div>

          <aside class="qp-right" *ngIf="activePlan && getPlanCoverages(activePlan) as covs">
            <header class="qp-right__head">
              <h3>Coberturas incluidas</h3>
              <span class="tiny-pill">Paquete recomendado</span>
            </header>

            <ul class="cov-list">

              <!-- EXTREP siempre se muestra manualmente -->
              <li class="cov-row">
                <div class="left">
                  <span class="label">Extensi√≥n de reparaci√≥n en agencia</span>
                </div>
                <div class="right">
                  <div class="extrep-container">
                    <span class="val" *ngIf="extrepStatus">{{ getEXTREPAmount() }}</span>
                    <div class="toggle-switch">
                      <label class="toggle">
                        <input type="checkbox" [checked]="extrepStatus" (change)="toggleExtrep()">
                        <span class="slider">
                          <span class="slider-text-off">OFF</span>
                          <span class="slider-text-on">ON</span>
                        </span>
                      </label>
                    </div>
                  </div>
                </div>
              </li>

              <!-- Las dem√°s coberturas del array -->
              <li class="cov-row" *ngFor="let c of covs">
                <ng-container *ngIf="hasValidCoverageInfo(c)">
                  <div class="left">
                    <span class="label">{{ c.label }}</span>
                  </div>
                  <div class="right">

                    <!-- Switch para Da√±os Materiales -->
                    <div class="deductible-switch" *ngIf="c.label === 'Da√±os Materiales'">
                      <div class="deductible-content">
                        <div class="deductible-info">
                          <span class="val">{{ getDAMount() }}</span>
                        </div>
                        <div class="deductible-controls">
                          <span class="deductible-label">Deducible:</span>
                          <div class="deductible-buttons">
                            <button type="button" class="deductible-option" [class.active]="selectDM_valor === 3"
                              (click)="selectDeductible(3)">
                              3%
                            </button>
                            <button type="button" class="deductible-option" [class.active]="selectDM_valor === 5"
                              (click)="selectDeductible(5)">
                              5%
                            </button>
                            <button type="button" class="deductible-option" [class.active]="selectDM_valor === 10"
                              (click)="selectDeductible(10)">
                              10%
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Switch para Robo Total -->
                    <div class="deductible-switch" *ngIf="c.label === 'Robo Total'">
                      <div class="deductible-content">
                        <div class="deductible-info">
                          <span class="val">{{ getRTAmount() }}</span>
                        </div>
                        <div class="deductible-controls">
                          <span class="deductible-label">Deducible:</span>
                          <div class="deductible-buttons">
                            <button type="button" class="deductible-option" [class.active]="selectRT_valor === 5"
                              (click)="selectRTDeductible(5)">
                              5%
                            </button>
                            <button type="button" class="deductible-option" [class.active]="selectRT_valor === 10"
                              (click)="selectRTDeductible(10)">
                              10%
                            </button>
                            <button type="button" class="deductible-option" [class.active]="selectRT_valor === 15"
                              (click)="selectRTDeductible(15)">
                              15%
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Para las dem√°s coberturas normales -->
                    <div *ngIf="c.label !== 'Da√±os Materiales' && c.label !== 'Robo Total'">
                      <span class="val" *ngIf="c.amountText">{{ c.amountText }}</span>
                      <span class="ded" *ngIf="c.deductible != null">¬∑ Deducible {{ (c.deductible * 100) |
                        number:'1.0-0' }}%</span>
                    </div>
                  </div>
                </ng-container>
              </li>
            </ul>
          </aside>

        </section>

      </section>

      <div class="historial-seguros" [ngClass]="{ 'is-step1': currentStep === 1 }">
        <div class="historial-cta" (click)="restaurarOIntercambiarCotizacion()"
          *ngIf="ultimaCotizacion?.datosCoche; else sinHistorial" aria-label="Mi √∫ltima cotizaci√≥n" role="button">
          <div class="historial-head">
            <span class="hist-label">Mi √∫ltima cotizaci√≥n</span>
            <ion-icon name="chevron-forward-outline" aria-hidden="true"></ion-icon>
          </div>

          <div class="hist-info">
            <h3>
              {{ ultimaCotizacion.datosCoche.marca | uppercase }}
              {{ ultimaCotizacion.datosCoche.modelo }}
            </h3>
            <p class="hist-version">Versi√≥n: {{ ultimaCotizacion.datosCoche.version }}</p>
            <p class="hist-year">A√±o: {{ ultimaCotizacion.datosCoche.anio }}</p>
          </div>

          <div class="hist-hint">Toca para ver</div>
        </div>

        <ng-template #sinHistorial>
        </ng-template>
      </div>

      <br><br>

    </div>

    <div class="divicion2">
      <app-otros-seguros *ngIf="tipoDispocitivo !== 'telefono'" [refreshKey]="islandKey"></app-otros-seguros>
    </div>
  </div>

  <app-footer *ngIf="tipoDispocitivo !== 'telefono'"></app-footer>
</ion-content>

<ion-footer class="safe-footer footer_css_seguros" *ngIf="tipoDispocitivo === 'telefono'">
  <ion-toolbar>

    <ion-buttons slot="start">
      <ion-button fill="clear" *ngIf="currentStep !== 1 && !cotizacion" (click)="ClearRegrasar()">
        <ion-icon slot="start" name="arrow-back-outline"></ion-icon>
        Atr√°s
      </ion-button>
      <!-- -----  -->
      <ion-button fill="solid" color="medium" *ngIf="cotizacion" (click)="nuevoSeguro()">
        <ion-icon slot="start" name="sync"></ion-icon>
        Cotizaci√≥n
      </ion-button>

      <ion-button fill="solid" color="warning" *ngIf="cotizacion" (click)="descargarCotizacionPDF()">
        <ion-icon slot="start" name="cloud-download"></ion-icon>
      </ion-button>
    </ion-buttons>

    <ion-buttons slot="end">
      <ion-button color="danger" *ngIf="cotizacion" fill="solid" type="button" (click)="confirmarCrearPersona()">
        Continuar
        <ion-icon slot="end" name="arrow-forward-outline"></ion-icon>
      </ion-button>
      <ion-button color="danger" *ngIf="!cotizacion" fill="solid" type="button" (click)="siguiente()" [disabled]="
        (currentStep===1 && form.get('marca')?.invalid) ||
        (currentStep===2 && (form.get('modelo')?.invalid || form.get('anio')?.invalid || form.get('version')?.invalid)) ||
        (currentStep===3 && form.get('nacDia')?.invalid || form.get('nacMes')?.invalid || form.get('nacAnio')?.invalid) ||
        (currentStep===4 && (form.get('cp')?.invalid || form.get('genero')?.invalid || form.get('estadoCivil')?.invalid))
      ">
        {{ currentStep < 7 ? 'Siguiente' : 'Cotizar' }} <ion-icon slot="end" name="arrow-forward-outline"></ion-icon>
      </ion-button>
    </ion-buttons>

  </ion-toolbar>
</ion-footer>