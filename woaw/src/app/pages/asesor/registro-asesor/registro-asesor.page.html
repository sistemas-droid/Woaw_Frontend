<ion-header>
  <ion-toolbar color="dark" class="toolbar-ios" mode="ios">
    <ion-title>Registro de Asesor</ion-title>

    <ion-buttons slot="end">
      <img src="/assets/icon/logo4.png" alt="woaw" class="logo" />
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="registro-ios" mode="ios">
  <!-- decor -->
  <div class="bg-decor" aria-hidden="true"></div>

  <div class="wrap">

    <!-- BLOQUEADO -->
    <div *ngIf="bloqueado" class="invite-expired">
      <div class="expired-card">
        <div class="expired-icon">
          <ion-icon name="alert-circle-outline"></ion-icon>
        </div>

        <h2 class="expired-title">Link expirado</h2>
        <p class="expired-text">{{ motivoBloqueo }}</p>
      </div>
    </div>

    <!-- FORM (solo si NO está bloqueado) -->
    <ng-container *ngIf="!bloqueado">

      <!-- HERO -->
      <header class="hero">
        <div class="hero-card">
          <div class="eyebrow">WOAW</div>
          <h1 class="titulo">Únete como Asesor</h1>
          <p class="subtitulo">3 pasos y te subimos al barco</p>

          <ion-progress-bar class="progress" [value]="progress"></ion-progress-bar>

          <div class="steps" aria-label="Pasos de registro">
            <div class="step" [class.active]="paso===1" [class.done]="paso>1">
              <span class="dot">1</span>
              <span class="label">Datos</span>
            </div>

            <div class="step" [class.active]="paso===2" [class.done]="paso>2">
              <span class="dot">2</span>
              <span class="label">Código</span>
            </div>

            <div class="step" [class.active]="paso===3">
              <span class="dot">3</span>
              <span class="label">Cuenta</span>
            </div>
          </div>
        </div>
      </header>

      <!-- CARD -->
      <ion-card class="card-form">
        <ion-card-content>

          <!-- PASO 1 -->
          <section *ngIf="paso === 1" class="panel">
            <div class="panel-head">
              <h2 class="panel-title">Tus datos</h2>
              <p class="panel-sub">Nombre, correo y teléfono. Rapidito.</p>
            </div>

            <div class="form-group">
              <ion-item class="i" lines="none">
                <ion-input label="Nombre" labelPlacement="stacked" [(ngModel)]="form.nombre"></ion-input>
              </ion-item>

              <ion-item class="i" lines="none">
                <ion-input label="Apellidos" labelPlacement="stacked" [(ngModel)]="form.apellidos"></ion-input>
              </ion-item>

              <ion-item class="i" lines="none">
                <ion-input label="Correo" type="email" labelPlacement="stacked" [(ngModel)]="form.email"></ion-input>
              </ion-item>

              <div class="row">
                <!-- Selector lada -->
                <ion-item class="i half lada-select" lines="none" (click)="abrirModalLadas()">
                  <ion-label position="stacked">Lada</ion-label>

                  <div class="lada-chip">
                    <img
                      [src]="'https://flagcdn.com/w40/' + ladaSeleccionada.bandera + '.png'"
                      class="flag-img"
                      alt="bandera"
                    />
                    <span class="lada-text">{{ ladaSeleccionada.codigo }}</span>
                    <ion-icon name="chevron-down-outline" class="chev"></ion-icon>
                  </div>
                </ion-item>

                <ion-item class="i half" lines="none">
                  <ion-input
                    label="Teléfono"
                    labelPlacement="stacked"
                    inputmode="tel"
                    [(ngModel)]="form.telefono"
                  ></ion-input>
                </ion-item>
              </div>

              <ion-button class="btn-primary" expand="block" [disabled]="cargando || bloqueado" (click)="enviarCodigo()">
                <ion-spinner *ngIf="cargando" name="crescent"></ion-spinner>
                <span *ngIf="!cargando">Enviar código</span>
              </ion-button>

              <p class="hint">
                Te llega un código a tu correo. Si no lo ves, checa spam.
              </p>
            </div>
          </section>

          <!-- PASO 2 -->
          <section *ngIf="paso === 2" class="panel">
            <div class="panel-head">
              <h2 class="panel-title">Verifica tu correo</h2>
              <p class="panel-sub">Enviamos un código a: <strong>{{ form.email }}</strong></p>
            </div>

            <div class="form-group">
              <ion-item class="i" lines="none">
                <ion-input
                  label="Código de verificación"
                  labelPlacement="stacked"
                  inputmode="numeric"
                  maxlength="6"
                  [(ngModel)]="form.code"
                ></ion-input>
              </ion-item>

              <div class="actions">
                <ion-button fill="outline" class="btn-secondary" [disabled]="cargando || bloqueado" (click)="volverPasoAnterior()">
                  Cambiar datos
                </ion-button>

                <ion-button class="btn-primary" [disabled]="cargando || bloqueado" (click)="validarCodigo()">
                  <ion-spinner *ngIf="cargando" name="crescent"></ion-spinner>
                  <span *ngIf="!cargando">Validar código</span>
                </ion-button>
              </div>

              <p class="hint">
                Si el código no coincide, vuelve a pedirlo con tus datos correctos.
              </p>
            </div>
          </section>

          <!-- PASO 3 -->
          <section *ngIf="paso === 3" class="panel">
            <div class="panel-head">
              <h2 class="panel-title">Crea tu cuenta</h2>
              <p class="panel-sub">Ya casi. Una contraseña y vámonos.</p>
            </div>

            <div class="form-group">
              <ion-item class="i" lines="none">
                <ion-input
                  label="Contraseña"
                  labelPlacement="stacked"
                  type="password"
                  [(ngModel)]="form.password"
                ></ion-input>
              </ion-item>

              <ion-item class="i" lines="none">
                <ion-input
                  label="Confirmar contraseña"
                  labelPlacement="stacked"
                  type="password"
                  [(ngModel)]="form.confirmPassword"
                ></ion-input>
              </ion-item>

              <div class="actions">
                <ion-button fill="outline" class="btn-secondary" [disabled]="cargando || bloqueado" (click)="volverPasoAnterior()">
                  Regresar
                </ion-button>

                <ion-button class="btn-primary success" [disabled]="cargando || bloqueado" (click)="crearCuenta()">
                  <ion-spinner *ngIf="cargando" name="crescent"></ion-spinner>
                  <span *ngIf="!cargando">Crear cuenta</span>
                </ion-button>
              </div>

              <p class="hint">
                Usa una contraseña fuerte. No te hagas el valiente con “123456”.
              </p>
            </div>
          </section>

        </ion-card-content>
      </ion-card>

      <footer class="foot">
        <span class="mini">WOAW • Asesores</span>
      </footer>

    </ng-container>
  </div>

  <!-- MODAL LADAS -->
  <ion-modal *ngIf="!bloqueado" [isOpen]="mostrarModal" (didDismiss)="cerrarModal()" class="modal-ladas" mode="ios">
    <ng-template>
      <ion-header>
        <ion-toolbar color="dark" class="modal-toolbar" mode="ios">
          <ion-title>Selecciona tu lada</ion-title>
          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="cerrarModal()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>

        <ion-toolbar class="modal-search" mode="ios">
          <ion-searchbar
            placeholder="Buscar país..."
            [(ngModel)]="filtroPais"
            (ionInput)="filtrarPaises()"
          ></ion-searchbar>
        </ion-toolbar>
      </ion-header>

      <ion-content class="modal-content" mode="ios">
        <ion-list class="modal-list">
          <ion-item button class="modal-item" *ngFor="let pais of paisesFiltrados" (click)="seleccionarLada(pais)">
            <img [src]="pais.banderaUrl" class="flag-img" alt="flag" />
            <ion-label>
              <div class="pais-nombre">{{ pais.nombre }}</div>
              <div class="pais-codigo">{{ pais.codigo }}</div>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>