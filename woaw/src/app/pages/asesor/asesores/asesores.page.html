<app-navbar></app-navbar>

<ion-content [fullscreen]="true" class="bg-asesores">

  <!-- ENCABEZADO -->
  <div class="encabezado-asesores contenedor-asesores">
    <div class="heading-left">
      <h1>Nuestros asesores</h1>
      <p>Selecciona al asesor que se encargará de brindarte la mejor atención.</p>

      <!-- ✅ ADMIN: GENERAR LINK TEMPORAL -->
      <div *ngIf="isAdmin" class="admin-invite">

        <div class="admin-actions">
          <ion-button size="small" color="danger" (click)="generarLinkInvitacion()" [disabled]="generandoLink">
            <ion-icon name="link-outline" slot="start"></ion-icon>
            <span *ngIf="!generandoLink">Generar link de registro</span>
            <span *ngIf="generandoLink">Generando…</span>
          </ion-button>

          <ion-button size="small" color="danger" *ngIf="!graficaEstatus" (click)="generarGraficas()">
            <ion-icon name="podium" slot="start"></ion-icon>
            Grafica
          </ion-button>

          <ion-button size="small" color="danger" *ngIf="graficaEstatus" (click)="generarGraficas()">
            <ion-icon name="logo-apple-ar" slot="start"></ion-icon>
            Lista
          </ion-button>
        </div>

        <div *ngIf="inviteLink" class="invite-box">
          <div class="invite-head">
            <div class="invite-title">
              <ion-icon name="time-outline"></ion-icon>
              <span>Link temporal</span>
            </div>
          </div>

          <div class="invite-url-row">
            <div class="invite-url" title="{{ inviteLink }}">
              {{ inviteLink }}
            </div>

            <button type="button" class="btn-copy-link" (click)="copiarInvite()">
              <ion-icon name="copy-outline"></ion-icon>
            </button>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- LIsta de asesores  -->
  <div class="contenedor-asesores" *ngIf="!graficaEstatus">
    <!-- LOADING -->
    <div class="loading" *ngIf="cargando">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Cargando asesores…</p>
    </div>

    <!-- ERROR -->
    <div class="error" *ngIf="error">
      <p>No se pudieron cargar los asesores.</p>
      <ion-button size="small" (click)="cargarAsesores()">Reintentar</ion-button>
    </div>

    <!-- TABLA DE ASESORES -->
    <div class="tabla-asesores-wrapper">

      <div class="acciones-tabla">
        <button type="button" class="btn-exportar" (click)="exportarExcel()">
          <ion-icon name="download-outline"></ion-icon>
          <span>Descargar Excel</span>
        </button>
      </div>

      <table class="tabla-asesores">
        <thead>
          <tr>
            <th>Asesor</th>
            <th>Teléfono</th>
            <th>Email</th>
            <th class="th-acciones">Acciones</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let asesor of asesoresPaginados">

            <td class="td-asesor">
              <div class="asesor-cell">
                <div class="asesor-avatar">
                  <img *ngIf="asesor?.foto" [src]="asesor.foto" alt="Foto asesor" class="avatar-img" />
                  <span *ngIf="!asesor?.foto">{{ getIniciales(nombreCompleto(asesor)) }}</span>
                </div>

                <div class="asesor-nombre">
                  <div class="nombre">{{ nombreCompleto(asesor) }}</div>
                  <div class="sub">{{ asesor.rol || 'Asesor Comercial' }}</div>
                </div>
              </div>
            </td>

            <td>
              <span *ngIf="asesor.telefono; else sinTel">
                <ion-icon name="call-outline"></ion-icon>
                ({{asesor.lada}}){{ asesor.telefono }}
              </span>
              <ng-template #sinTel>
                <span class="muted">-</span>
              </ng-template>
            </td>

            <td>
              <span *ngIf="asesor.email; else sinMail">
                <ion-icon name="mail-outline"></ion-icon>
                {{ asesor.email }}
              </span>
              <ng-template #sinMail>
                <span class="muted">-</span>
              </ng-template>
            </td>

            <td class="td-acciones">
              <!-- <button type="button" class="btn-link-qr" (click)="abrirLink(asesor.telefono)"
                [disabled]="!asesor.telefono">
                <ion-icon name="link-outline"></ion-icon>
                <span>Ver enlace</span>
              </button> -->

              <button type="button" class="btn-editar-asesor" (click)="editarAsesor(asesor)" [disabled]="!asesor._id">
                <ion-icon name="create-outline"></ion-icon>
                <span>Editar</span>
              </button>

              <button *ngIf="isAdmin" type="button" class="btn-eliminar-asesor" (click)="confirmarEliminar(asesor)"
                [disabled]="!asesor._id || eliminandoId === asesor._id" aria-label="Eliminar asesor">
                <ion-icon name="trash-outline"></ion-icon>
                <span *ngIf="eliminandoId !== asesor._id">Eliminar</span>
                <span *ngIf="eliminandoId === asesor._id">Eliminando…</span>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      
      <div class="paginacion" *ngIf="totalPaginas > 1">
        <button type="button" (click)="prevPage()" [disabled]="paginaActual === 1">
          Anterior
        </button>

        <button type="button" *ngFor="let p of paginasVisibles" (click)="goToPage(p)"
          [class.active]="p === paginaActual">
          {{ p }}
        </button>

        <button type="button" (click)="nextPage()" [disabled]="paginaActual === totalPaginas">
          Siguiente
        </button>

        <span class="paginacion-info">
          {{ paginaActual }} / {{ totalPaginas }} · {{ asesores.length }} asesores
        </span>
      </div>

    </div>


  </div>

  <!-- Grafica  -->
  <div *ngIf="graficaEstatus" class="contenedor-asesores">
    <div class="kpi-card">
      <div class="kpi-header">
        <div class="kpi-left">
          <div class="kpi-dot"></div>
          <div class="kpi-title">Asesores</div>
        </div>

        <div class="kpi-right">
          <div class="kpi-value">{{ totalAsesores }}</div>
          <div class="kpi-sub">total asesores</div>
        </div>
      </div>

      <div id="chartAsesores" class="kpi-chart"></div>
    </div>
  </div>

  <!-- modal  -->
  <ion-modal [isOpen]="modalEliminarOpen" (didDismiss)="cerrarModalEliminar()" cssClass="woaw-modal-eliminar">
    <ng-template>
      <div class="woaw-modal-center">
        <div class="modal-card">
          <div class="modal-head">
            <div class="title-wrap">
              <h3>Eliminar asesor</h3>
              <span class="badge-danger">Acción crítica</span>
            </div>

            <button type="button" class="x-btn" (click)="cerrarModalEliminar()" aria-label="Cerrar">
              <ion-icon name="close-outline"></ion-icon>
            </button>
          </div>

          <div class="modal-body">
            <p>
              Vas a eliminar a
              <strong>{{ asesorAEliminar ? nombreCompleto(asesorAEliminar) : 'este asesor' }}</strong>.
            </p>
            <p class="warn">Esta acción no se puede deshacer.</p>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-modal btn-cancel" (click)="cerrarModalEliminar()">
              Cancelar
            </button>

            <button type="button" class="btn-modal btn-danger" (click)="confirmarEliminarModal()"
              [disabled]="!asesorAEliminar?._id || eliminandoId === asesorAEliminar?._id">
              <ion-icon name="trash-outline"></ion-icon>
              <span *ngIf="eliminandoId !== asesorAEliminar?._id">Eliminar</span>
              <span *ngIf="eliminandoId === asesorAEliminar?._id">Eliminando…</span>
            </button>
          </div>
        </div>
      </div>
    </ng-template>
  </ion-modal>

  <app-footer></app-footer>
</ion-content>