<!-- <app-navbar></app-navbar> -->
<ion-header>
  <ion-toolbar color="dark">
    <ion-buttons slot="start">
      <ion-button fill="clear" (click)="regresar()">
        <ion-icon name="chevron-back-outline"></ion-icon>
        <img src="/assets/icon/logo4.png" loading="lazy" alt="WOAW" class="logo" />
      </ion-button>
      <ion-title *ngIf="!esDispositivoMovil">
        <span *ngIf="auto" class="titulo-perfil">{{ auto.marca }} {{ auto.modelo }} {{ auto.anio }}</span>
      </ion-title>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button fill="solid" shape="round" *ngIf="!esMio" color="success"
        (click)="contactosService.contactarWOAW(auto, 'autos')">
        <!-- <span *ngIf="!esDispositivoMovil">WhatsApp</span> -->
        WhatsApp
        <ion-icon slot="start" name="logo-whatsapp"></ion-icon>
      </ion-button>
      <ion-button fill="solid" shape="round" color="medium" (click)="contactosService.compartirAuto(auto, 'autos')">
        <!-- <span *ngIf="!esDispositivoMovil">Compartir</span> -->
        Compartir
        <ion-icon slot="start" name="share-social-outline"></ion-icon>
      </ion-button>
      <ion-button fill="solid" shape="round" color="danger" *ngIf="!esMio && tipo === 'nuevo'"
        (click)="contactosService.ArrendamientoAuto(auto)">
        <!-- <span *ngIf="!esDispositivoMovil">Arrendar</span> -->
        Arrendar
        <ion-icon slot="start" name="logo-model-s"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>


<ion-content class="ficha-auto" [fullscreen]="true">

  <!-- SPINNER DE CARGA -->
  <div class="spinner-ficha-wrapper" *ngIf="!spinner">
    <div class="spinner-ficha"></div>
    <div class="spinner-texto">Cargando vehículo...</div>
  </div>

  <ion-grid *ngIf="auto" class="contenedor_ficha">
    <ion-row>
      <!-- IMAGENES ---  -->
      <ion-col size="12" size-md="6">
        <div class="contenedor-imagenes">
          <!-- Imagen principal -->
          <div class="contenedor_imagen_principal" (touchstart)="esDispositivoMovil && onTouchStart($event)"
            (touchend)="esDispositivoMovil && onTouchEnd($event)">
            <div class="imagen-principal"
              (click)="abrirModalImagen(auto.imagenes, auto.imagenes.indexOf(imagenSeleccionada)); $event.stopPropagation()">
              <img [src]="imagenSeleccionada" alt="Imagen principal del auto" (load)="onImagenPrincipalCargada()" />

              <div class="loader_carta" *ngIf="!imagenPrincipalCargada">
                <div class="spinner_carta"></div>
                <span class="texto_cargando">Cargando...</span>
              </div>

              <ng-container *ngIf="!esDispositivoMovil">
                <button class="flecha izquierda" (click)="cambiarImagen('anterior'); $event.stopPropagation()"
                  [disabled]="imagenSeleccionada === auto.imagenes[0]">
                  ‹
                </button>
                <button class="flecha derecha" (click)="cambiarImagen('siguiente'); $event.stopPropagation()"
                  [disabled]="imagenSeleccionada === auto.imagenes[auto.imagenes.length - 1]">
                  ›
                </button>
              </ng-container>
            </div>
          </div>

          <div class="galeria-inferior">
            <div class="miniaturas-horizontal">
              <ng-container *ngFor="let img of auto.imagenes; let i = index">
                <div class="thumb-wrapper" *ngIf="i < 4">
                  <img [src]="img" alt="Miniatura" [class.activa]="img === imagenSeleccionada"
                    [class.oculta]="!miniaturasCargadas[img]" (click)="imagenSeleccionada = img"
                    (load)="onMiniaturaCargada(img)" />

                  <div class="loader_miniatura" *ngIf="!miniaturasCargadas[img]">
                    <div class="spinner_miniatura"></div>
                  </div>
                </div>
              </ng-container>

              <button *ngIf="auto.imagenes?.length > 4" type="button" class="cta-fotos"
                (click)="abrirModalImagen(auto.imagenes, auto.imagenes.indexOf(imagenSeleccionada))">
                <span>más</span>
                <ion-icon name="chevron-forward-outline"></ion-icon>
              </button>
            </div>
          </div>
        </div>
      </ion-col>

      <!-- PRECIO --- -->
      <ion-col size="12" size-md="6">
        <div *ngIf="auto.estadoVehiculo === 'disponible'" class="card-detalle">
          <ion-grid>
            <ion-row>
              <ion-col size="12" size-md="8">
                <h2>{{ auto.marca }} {{ auto.modelo }} {{ auto.anio }}</h2>
                <p class="precio-principal">
                  {{ versionSeleccionada?.nombre }}:
                </p>

                <p class="precio-valor">
                  {{ versionSeleccionada?.precio | currency:'MXN':'symbol':'1.0-0'
                  }}
                </p>
                <!-- Versiones -->
                <div class="versiones" *ngIf="tipo === 'nuevo'">
                  <p class="titulo-seccion">Versiones</p>
                  <div class="version" *ngFor="let version of versiones" (click)="onSeleccionarVersion(version)"
                    [class.activa]="versionSeleccionada?.nombre === version.nombre">
                    <span>{{ version.nombre }}</span>
                    <span class="precio-version">{{ version.precio | currency:'MXN':'symbol' }}</span>
                  </div>
                </div>

                <!-- Botón contactar -->
                <!-- <div class="botones-contacto-responsive">
                  <button *ngIf="!esMio" (click)="contactosService.contactarWOAW(auto, 'autos')"
                    class="btn-personalizado success">
                    <ion-icon name="logo-whatsapp"></ion-icon>
                    WhatsApp
                  </button>

                  <button (click)="contactosService.compartirAuto(auto, 'autos')" class="btn-personalizado medium">
                    <ion-icon name="share-social-outline"></ion-icon>
                    Compartir
                  </button>

                  <br />
                  <button *ngIf="MyRole !== 'admin' && !esMio" class="btn-personalizado danger"
                    (click)="contactosService.ArrendamientoAuto(auto)">
                    <ion-icon name="car-sport"></ion-icon>
                    Arrendar
                  </button>
                </div> -->

                <p *ngIf="!isLoggedIn" class="mensaje_contacto">
                  Al contactar estás aceptando el
                  <strong (click)="aviso(0)">Aviso de Privacidad</strong> y los
                  <strong (click)="aviso(1)">Términos y condiciones</strong>
                </p>

                <p>
                  {{auto.descripcion}}
                </p>
              </ion-col>

              <ion-col size="12" size-md="4">
                <ion-card class="card-contacto">
                  <!-- VENDEDOR (cuando no hay lote y solo tú/admin lo ven) -->
                  <ion-card-content *ngIf="auto.lote == null && (MyRole == 'admin' || esMio)"
                    class="card-contacto__content">
                    <p class="card-contacto__label">Vendedor</p>

                    <div class="card-contacto__fila">
                      <ion-icon name="person-circle-outline"></ion-icon>
                      <span>{{ auto.usuarioId.nombre }} {{ auto.usuarioId.apellidos }}</span>
                    </div>

                    <div class="card-contacto__fila">
                      <ion-icon name="mail-outline"></ion-icon>
                      <span>{{ auto.usuarioId.email }}</span>
                    </div>

                    <div class="card-contacto__fila">
                      <ion-icon name="call-outline"></ion-icon>
                      <span>{{ auto.usuarioId.lada }} {{ auto.usuarioId.telefono }}</span>
                    </div>
                  </ion-card-content>

                  <!-- LOTE -->
                  <ion-card-content *ngIf="auto.lote != null"
                    class="card-contacto__content card-contacto__content--clickable" (click)="mostrarAutos(auto.lote)">
                    <p class="card-contacto__label">
                       {{ auto.lote.nombre }}
                    </p>

                    <div class="card-lote">
                      <div class="card-lote__logo">
                        <ion-avatar>
                          <img [src]="auto.lote.imagenPrincipal" alt="Logo del lote" />
                        </ion-avatar>
                      </div>

                      <div class="card-lote__info">
                        <div class="card-lote__fila">
                          <ion-icon name="business-outline"></ion-icon>
                          <div class="card-lote__nombre">
                            Lote
                          </div>
                        </div>

                        <div class="card-lote__fila">
                          <ion-icon name="call-outline"></ion-icon>
                          <span>+52 {{ auto.lote.telefonoContacto }}</span>
                        </div>
                      </div>
                    </div>
                  </ion-card-content>
                </ion-card>
              </ion-col>

            </ion-row>
          </ion-grid>

          <!-- Componente de cotizador Nuevos ☢️ -->
          <app-cotizador *ngIf="mostrarCotizador" [coche]="auto" [versionNuevo]="versionSeleccionada?.nombre ?? null"
            [precioNuevo]="versionSeleccionada?.precio ?? null">
          </app-cotizador>

        </div>
        <div class="overlay" *ngIf="auto.estadoVehiculo === 'vendido'">
          <img src="/assets/icon/vendido.png" alt="Vendido" />
        </div>
      </ion-col>
    </ion-row>

    <!-- ------ ----- ----- ----- ----- ---- ----- ----- ----- ----- ---- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -->

    <ion-row>
      <!-- ESPESIFICACIONES ---  -->
      <ion-col size="12" size-lg="6">
        <div class="especificaciones">
          <!-- NUEVO -->
          <ng-container *ngIf="tipo === 'nuevo'; else usadoSeminuevo">
            <ng-container *ngFor="let esp of especificacionesAuto; let i = index">
              <div class="espec-compacta">
                <h4>Especificaciones del vehículo</h4>

                <h5 *ngIf="especificacionesAuto.length > 1">
                  Versión {{ i + 1 }}: {{ esp.version }}
                </h5>

                <div class="specs-grid">
                  <!-- Columna izquierda -->
                  <div class="spec-col">
                    <p *ngIf="esp.marca">
                      <span class="label">Marca:</span>
                      <span class="value">{{ esp.marca }}</span>
                    </p>

                    <p *ngIf="esp.modelo">
                      <span class="label">Modelo:</span>
                      <span class="value">{{ esp.modelo }}</span>
                    </p>

                    <p *ngIf="esp.motor">
                      <span class="label">Motor:</span>
                      <span class="value">{{ esp.motor }}</span>
                    </p>

                    <p *ngIf="esp.cilindros">
                      <span class="label">Cilindros:</span>
                      <span class="value">{{ esp.cilindros }}</span>
                    </p>

                    <p *ngIf="esp.traccion">
                      <span class="label">Tracción:</span>
                      <span class="value">{{ esp.traccion }}</span>
                    </p>

                    <p *ngIf="esp.transmision">
                      <span class="label">Transmisión:</span>
                      <span class="value">{{ esp.transmision }}</span>
                    </p>
                  </div>

                  <!-- Columna derecha -->
                  <div class="spec-col">
                    <p *ngIf="esp.puertas">
                      <span class="label">Puertas:</span>
                      <span class="value">{{ esp.puertas }}</span>
                    </p>

                    <p *ngIf="esp.pasajeros">
                      <span class="label">Pasajeros:</span>
                      <span class="value">{{ esp.pasajeros }}</span>
                    </p>

                    <p *ngIf="esp.rines">
                      <span class="label">Rines:</span>
                      <span class="value">{{ esp.rines }}</span>
                    </p>

                    <p *ngIf="esp.combustible">
                      <span class="label">Combustible:</span>
                      <span class="value">{{ esp.combustible }}</span>
                    </p>

                    <p *ngIf="esp.anio">
                      <span class="label">Año:</span>
                      <span class="value">{{ esp.anio }}</span>
                    </p>

                    <p *ngIf="esp.tipoVehiculo">
                      <span class="label">Tipo:</span>
                      <span class="value">{{ esp.tipoVehiculo }}</span>
                    </p>
                  </div>
                </div>

                <div class="spec-extra" *ngIf="esp.extra?.length">
                  <span class="label">Extras:</span>
                  <span class="value">{{ esp.extra.join(' · ') }}</span>
                </div>
              </div>
            </ng-container>
          </ng-container>

          <!-- SEMINUEVO / USADO -->
          <ng-template #usadoSeminuevo>
            <div class="espec-compacta">
              <h4>Especificaciones del vehículo</h4>

              <div class="specs-grid">
                <!-- Columna izquierda -->
                <div class="spec-col">
                  <p *ngIf="auto.facturaOriginal">
                    <span class="label">Factura original</span>
                    <span class="value">{{ auto.facturaOriginal }}</span>
                  </p>

                  <p *ngIf="auto.motor || auto.potencia">
                    <span class="label">Motor:</span>
                    <span class="value">
                      <ng-container *ngIf="auto.motor">{{ auto.motor }}</ng-container>
                      <ng-container *ngIf="auto.potencia"> · {{ auto.potencia }}</ng-container>
                    </span>
                  </p>

                  <p *ngIf="auto.cilindros">
                    <span class="label">Cilindros:</span>
                    <span class="value">{{ auto.cilindros }}</span>
                  </p>

                  <p *ngIf="auto.traccion">
                    <span class="label">Tracción:</span>
                    <span class="value">{{ auto.traccion }}</span>
                  </p>

                  <p *ngIf="auto.transmision">
                    <span class="label">Transmisión:</span>
                    <span class="value">{{ auto.transmision }}</span>
                  </p>
                </div>

                <!-- Columna derecha -->
                <div class="spec-col">
                  <p *ngIf="auto.kilometraje !== undefined && auto.kilometraje !== null">
                    <span class="label">Kilometraje:</span>
                    <span class="value">{{ auto.kilometraje | number }} km</span>
                  </p>

                  <p *ngIf="auto.rines">
                    <span class="label">Rines:</span>
                    <span class="value">{{ auto.rines }}</span>
                  </p>

                  <p *ngIf="auto.pasajeros">
                    <span class="label">Pasajeros:</span>
                    <span class="value">{{ auto.pasajeros }}</span>
                  </p>

                  <p *ngIf="auto.color">
                    <span class="label">Color:</span>
                    <span class="value">{{ auto.color }}</span>
                  </p>

                  <p *ngIf="auto.anio">
                    <span class="label">Año:</span>
                    <span class="value">{{ auto.anio }}</span>
                  </p>
                </div>
              </div>

              <div class="spec-extra" *ngIf="auto.extra?.length">
                <span class="label">Extras:</span>
                <span class="value">{{ auto.extra.join(' · ') }}</span>
              </div>

              <div class="spec-extra" *ngIf="auto.descripcion">
                <span class="label">Descripción:</span>
                <span class="value">{{ auto.descripcion }}</span>
              </div>
            </div>
          </ng-template>
        </div>
      </ion-col>

      <!-- MAPA UBICACIÓN ---  -->
      <ion-col size="12" size-lg="6">
        <ion-card class="mapa_admin">
          <h1 class="text_ubicacion">Ubicación</h1>
          <div #mapAutoContainer style="width: 100%; height: 300px; border-radius: px;"></div>
          <!-- Dirección debajo del mapa -->
          <ion-card-content style="margin-top: 0.2rem; font-size: 14px; color: #4b5563;">
            <ion-icon name="location-outline" style="margin-right: 6px;"></ion-icon>
            {{ direccionCompleta }}
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>

  <div class="vehiculo-no-disponible" *ngIf="!auto">
    <p>¡Ups! Este vehículo no está disponible en este momento.</p>
  </div>


  <app-sugerencias [idCar]="idvehiculo"></app-sugerencias>
  <app-footer></app-footer>
</ion-content>