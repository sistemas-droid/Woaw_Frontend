<!-- <app-navbar></app-navbar> -->
<ion-header>
  <ion-toolbar color="dark">
    <ion-buttons slot="start">
      <ion-button fill="clear" (click)="regresar()">
        <ion-icon name="chevron-back-outline"></ion-icon>
        <img src="/assets/icon/logo4.png" loading="lazy" alt="WOAW" class="logo" />
      </ion-button>

      <ion-title *ngIf="!esDispositivoMovil">
        <span *ngIf="auto" class="titulo-perfil">{{ auto.marca }} {{ auto.modelo }} {{ auto.anio }}</span>
      </ion-title>
    </ion-buttons>

    <ion-buttons slot="end">
      <ion-button fill="solid" shape="round" *ngIf="!esMio && !esDispositivoMovil" color="success"
        (click)="contactosService.contactarWOAW(auto, 'autos')">
        <span *ngIf="!esDispositivoMovil">WhatsApp</span>
        <ion-icon slot="start" name="logo-whatsapp"></ion-icon>
      </ion-button>

      <ion-button fill="clear" shape="round" (click)="contactosService.compartirAuto(auto, 'autos')">
        <span>Compartir</span>
        <ion-icon slot="start" name="share-social-outline"></ion-icon>
      </ion-button>

      <ion-button fill="solid" shape="round" color="danger" *ngIf="!esMio && tipo === 'nuevo' && !esDispositivoMovil"
        (click)="contactosService.ArrendamientoAuto(auto)">
        <span *ngIf="!esDispositivoMovil">Arrendar</span>
        <ion-icon slot="start" name="car-sport-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ficha-auto" [fullscreen]="true">

  <!-- SPINNER DE CARGA -->
  <div class="spinner-ficha-wrapper" *ngIf="!spinner">
    <div class="spinner-ficha"></div>
    <div class="spinner-texto">Cargando vehículo...</div>
  </div>

  <ion-grid *ngIf="auto" class="contenedor_ficha">
    <ion-row>

      <!-- IMAGENES -->
      <ion-col size="12" size-md="6">
        <div class="contenedor-imagenes">

          <!-- Imagen principal -->
          <div class="contenedor_imagen_principal" (touchstart)="esDispositivoMovil && onTouchStart($event)"
            (touchend)="esDispositivoMovil && onTouchEnd($event)">

            <div class="imagen-principal"
              (click)="galeriaImagenes.length ? abrirModalImagen(galeriaImagenes, galeriaImagenes.indexOf(imagenSeleccionada)) : null; $event.stopPropagation()">

              <!-- CASO AUTO NUEVO -->
              <ng-container *ngIf="tipo === 'nuevo'; else imagenNormal">
                <div class="imagen-nuevo-wrapper">
                  <!-- fondo -->
                  <div class="fondo-nuevo" *ngIf="tieneFondoNuevo()"></div>

                  <!-- coche -->
                  <img class="imagen-auto-nuevo" [src]="imagenSeleccionada" alt="Imagen principal del auto"
                    (load)="onImagenPrincipalCargada()" />
                </div>
              </ng-container>

              <!-- CASO NORMAL -->
              <ng-template #imagenNormal>
                <img [src]="imagenSeleccionada" alt="Imagen principal del auto" (load)="onImagenPrincipalCargada()" />
              </ng-template>

              <!-- loader -->
              <div class="loader_carta" *ngIf="!imagenPrincipalCargada">
                <div class="spinner_carta"></div>
                <span class="texto_cargando">Cargando...</span>
              </div>

              <!-- flechas desktop -->
              <ng-container *ngIf="!esDispositivoMovil && galeriaImagenes.length > 1">

                <button class="flecha izquierda" (click)="cambiarImagen('anterior'); $event.stopPropagation()"
                  [disabled]="imagenSeleccionada === galeriaImagenes[0]">
                  ‹
                </button>

                <button class="flecha derecha" (click)="cambiarImagen('siguiente'); $event.stopPropagation()"
                  [disabled]="imagenSeleccionada === galeriaImagenes[galeriaImagenes.length - 1]">
                  ›
                </button>

              </ng-container>

            </div>
          </div>

          <!-- Miniaturas.   && tipo !== 'nuevo' -->
          <div class="galeria-inferior" *ngIf="galeriaImagenes.length">
            <div class="miniaturas-horizontal">

              <ng-container *ngFor="let img of galeriaImagenes; let i = index">
                <div class="thumb-wrapper" *ngIf="i < 4">
                  <img [src]="img" alt="Miniatura" [class.activa]="img === imagenSeleccionada"
                    [class.oculta]="!miniaturasCargadas[img]" (click)="imagenSeleccionada = img"
                    (load)="onMiniaturaCargada(img)" />

                  <div class="loader_miniatura" *ngIf="!miniaturasCargadas[img]">
                    <div class="spinner_miniatura"></div>
                  </div>
                </div>
              </ng-container>

              <button *ngIf="galeriaImagenes.length > 4" type="button" class="cta-fotos"
                (click)="abrirModalImagen(galeriaImagenes, galeriaImagenes.indexOf(imagenSeleccionada))">
                <span>más</span>
                <ion-icon name="chevron-forward-outline"></ion-icon>
              </button>

            </div>
          </div>

        </div>

        <!-- MAPA DESKTOP -->
        <ion-col size="12" *ngIf="!esDispositivoMovil">
          <ion-card class="mapa_admin">
            <h1 class="text_ubicacion">Ubicación</h1>
            <div #mapAutoContainer style="width: 100%; height: 300px; border-radius: px;"></div>
            <ion-card-content style="margin-top: 0.2rem; font-size: 14px; color: #4b5563;">
              <ion-icon name="location-outline" style="margin-right: 6px;"></ion-icon>
              {{ direccionCompleta }}
            </ion-card-content>
          </ion-card>
        </ion-col>

      </ion-col>

      <!-- PRECIO -->
      <ion-col size="12" size-md="6">
        <div *ngIf="auto.estadoVehiculo === 'disponible'" class="card-detalle">

          <ion-grid>
            <ion-row>

              <!-- PRECIO -->
              <ion-col size="12" size-md="7" class="precio-col">
                <h2>{{ auto.marca }} {{ auto.modelo }} {{ auto.anio }}</h2>

                <p class="precio-principal">
                  {{ versionSeleccionada?.nombre }}:
                </p>

                <p class="precio-valor">
                  {{ versionSeleccionada?.precio | currency:'MXN':'symbol':'1.0-0' }}
                </p>

                <p *ngIf="!isLoggedIn" class="mensaje_contacto">
                  Al contactar estás aceptando el
                  <strong (click)="aviso(0)">Aviso de Privacidad</strong> y los
                  <strong (click)="aviso(1)">Términos y condiciones</strong>
                </p>
              </ion-col>

              <!-- VERSIONES -->
              <ion-col size="12" size-md="5">
                <div class="versiones" *ngIf="tipo === 'nuevo'">
                  <p class="titulo-seccion">Versiones</p>

                  <div class="version" *ngFor="let version of versiones" (click)="onSeleccionarVersion(version)"
                    [class.activa]="versionSeleccionada?.nombre === version.nombre">

                    <span>{{ version.nombre }}</span>
                    <span class="precio-version">{{ version.precio | currency:'MXN':'symbol' }}</span>
                  </div>
                </div>

                <ion-card class="card-contacto"></ion-card>
              </ion-col>

              <!-- COTIZADOR -->
              <ion-col size="12">
                <app-cotizador *ngIf="mostrarCotizador" [coche]="auto"
                  [versionNuevo]="versionSeleccionada?.nombre ?? null"
                  [precioNuevo]="versionSeleccionada?.precio ?? null">
                </app-cotizador>
              </ion-col>

              <!-- ESPECIFICACIONES -->
              <ion-col size="12" class="specs-col">
                <ion-grid class="specs-clean">
                  <h4 class="specs-title">Especificaciones del vehículo</h4>

                  <ng-container *ngIf="tipo === 'nuevo'; else usadoSeminuevo">
                    <ng-container *ngFor="let esp of especificacionesAuto; let i = index">

                      <h5 *ngIf="especificacionesAuto.length > 1" class="version">
                        Versión {{ i + 1 }}: {{ esp.version }}
                      </h5>

                      <div class="spec-list">
                        <div class="spec-item" *ngIf="esp.motor">
                          <span>Motor</span><span>{{ esp.motor }}</span>
                        </div>

                        <div class="spec-item" *ngIf="esp.cilindros">
                          <span>Cilindros</span><span>{{ esp.cilindros }}</span>
                        </div>

                        <div class="spec-item" *ngIf="esp.traccion">
                          <span>Tracción</span><span>{{ esp.traccion }}</span>
                        </div>

                        <div class="spec-item" *ngIf="esp.transmision">
                          <span>Transmisión</span><span>{{ esp.transmision }}</span>
                        </div>

                        <div class="spec-item" *ngIf="esp.pasajeros">
                          <span>Pasajeros</span><span>{{ esp.pasajeros }}</span>
                        </div>

                        <div class="spec-item" *ngIf="esp.rines">
                          <span>Rines</span><span>{{ esp.rines }}</span>
                        </div>

                        <div class="spec-item" *ngIf="esp.anio">
                          <span>Año</span><span>{{ esp.anio }}</span>
                        </div>
                      </div>

                    </ng-container>
                  </ng-container>

                  <!-- USADO / SEMINUEVO -->
                  <ng-template #usadoSeminuevo>
                    <div class="spec-list">

                      <div class="spec-item" *ngIf="auto.lote == null && (MyRole == 'admin' || esMio)">
                        <span>Vendedor:</span>
                        <span>
                          <span>{{ auto.usuarioId.nombre }} {{ auto.usuarioId.apellidos }}</span>
                          <br>
                          <span>{{ auto.usuarioId.email }}</span>
                          <br>
                          <span>{{ auto.usuarioId.lada }} {{ auto.usuarioId.telefono }}</span>
                          <br>
                        </span>
                      </div>

                      <div class="spec-item" *ngIf="auto.lote != null">
                        <span>Lote</span>
                        <span (click)="mostrarAutos(auto.lote)">
                          <ion-avatar>
                            <img [src]="auto.lote.imagenPrincipal" alt="Logo del lote" />
                          </ion-avatar>
                          {{ auto.lote.nombre }}
                        </span>
                      </div>

                      <div class="spec-item" *ngIf="auto.motor || auto.potencia">
                        <span>Motor</span>
                        <span>
                          {{ auto.motor }}
                          <ng-container *ngIf="auto.potencia">· {{ auto.potencia }}</ng-container>
                        </span>
                      </div>

                      <div class="spec-item" *ngIf="auto.cilindros">
                        <span>Cilindros</span><span>{{ auto.cilindros }}</span>
                      </div>

                      <div class="spec-item" *ngIf="auto.traccion">
                        <span>Tracción</span><span>{{ auto.traccion }}</span>
                      </div>

                      <div class="spec-item" *ngIf="auto.transmision">
                        <span>Transmisión</span><span>{{ auto.transmision }}</span>
                      </div>

                      <div class="spec-item" *ngIf="auto.kilometraje !== null">
                        <span>Kilometraje</span><span>{{ auto.kilometraje | number }} km</span>
                      </div>

                      <div class="spec-item" *ngIf="auto.color">
                        <span>Color</span><span>{{ auto.color }}</span>
                      </div>

                      <div class="spec-item" *ngIf="auto.anio">
                        <span>Año</span><span>{{ auto.anio }}</span>
                      </div>

                      <div class="spec-item" *ngIf="auto.anio">
                        <span></span><span>{{ auto.descripcion }}</span>
                      </div>

                    </div>
                  </ng-template>

                </ion-grid>
              </ion-col>

            </ion-row>
          </ion-grid>

        </div>

        <div class="overlay" *ngIf="auto.estadoVehiculo === 'vendido'">
          <img src="/assets/icon/vendido.png" alt="Vendido" />
        </div>

      </ion-col>
    </ion-row>

    <!-- MAPA MOVIL -->
    <ion-row *ngIf="esDispositivoMovil">
      <ion-col size="12">
        <ion-card class="mapa_admin">
          <h1 class="text_ubicacion">Ubicación</h1>
          <div #mapAutoContainer style="width: 100%; height: 300px; border-radius: px;"></div>
          <ion-card-content style="margin-top: 0.2rem; font-size: 14px; color: #4b5563;">
            <ion-icon name="location-outline" style="margin-right: 6px;"></ion-icon>
            {{ direccionCompleta }}
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>

  </ion-grid>

  <div class="vehiculo-no-disponible" *ngIf="!auto">
    <p>¡Ups! Este vehículo no está disponible en este momento.</p>
  </div>

  <app-sugerencias [idCar]="idvehiculo"></app-sugerencias>
  <app-footer></app-footer>

</ion-content>

<ion-footer *ngIf="!esMio && esDispositivoMovil" class="footer-acciones">
  <ion-toolbar color="dark">
    <ion-grid>
      <ion-row class="ion-align-items-center ion-justify-content-center">

        <!-- WHATSAPP -->
        <ion-col [size]="tipo === 'nuevo' ? 6 : 12" class="ion-text-center">
          <ion-button fill="outline" expand="block" color="success" shape="round"
            (click)="contactosService.contactarWOAW(auto, 'autos')">
            <ion-icon slot="start" name="logo-whatsapp"></ion-icon>
            WhatsApp
          </ion-button>
        </ion-col>

        <!-- ARRENDAR -->
        <ion-col size="6" *ngIf="tipo === 'nuevo'" class="ion-text-center">
          <ion-button fill="outline" expand="block" color="danger" shape="round"
            (click)="contactosService.ArrendamientoAuto(auto)">
            <ion-icon slot="start" name="car-sport-outline"></ion-icon>
            Arrendar
          </ion-button>
        </ion-col>

      </ion-row>
    </ion-grid>
  </ion-toolbar>
</ion-footer>