<app-navbar></app-navbar>

<ion-content [fullscreen]="true" class="docs-ios" mode="ios">
  <div class="page-wrap">

    <!-- ===================== PASO 1: RFC ===================== -->
    <section class="step-card" *ngIf="!yaIngresoRFC">
      <div class="step-head">
        <h1 class="step-title">Validar RFC del Lote</h1>
        <p class="step-subtitle">
          Ingresa el RFC para determinar si eres Persona Física o Moral.
        </p>
      </div>

      <div class="step-body">
        <div class="ios-field">
          <label class="ios-label">RFC del Lote</label>

          <ion-item lines="none" class="ios-item">
            <ion-input
              [(ngModel)]="rfc"
              (ionInput)="validarRFC()"
              maxlength="13"
              clearInput
              placeholder="Ej. ABCD001122XXX"
              inputmode="text"
              autocapitalize="characters"
            ></ion-input>
          </ion-item>

          <p *ngIf="rfcError" class="ios-error">
            {{ rfcError }}
          </p>
        </div>

        <ion-button
          expand="block"
          color="danger"
          class="btn-primary-ios"
          [disabled]="!rfcValido"
          (click)="enviarRFC()"
          mode="ios"
        >
          Continuar
        </ion-button>
      </div>
    </section>

    <!-- ===================== PASO 2: DOCUMENTOS ===================== -->
    <section *ngIf="yaIngresoRFC">

      <!-- HEADER + PROGRESO -->
      <section class="progress-card">
        <div class="progress-head">
          <h1 class="step-title">Documentación Requerida</h1>
          <p class="step-subtitle">
            Para completar tu solicitud, necesitamos los siguientes documentos.
          </p>
        </div>

        <div class="progress-body">

          <!-- Head progreso -->
          <div class="steps-head">
            <div class="steps-title">PROGRESO</div>

            <span class="steps-count">
              {{ getUploadedCount() }}/{{ getTotalDocsRequeridos() }}
            </span>

            <div class="steps-meta">
              <span class="steps-percent">{{ getProgressPercentage() }}%</span>
            </div>
          </div>

          <!-- Línea + bolitas con palomitas -->
          <div
            class="steps-line"
            [style.--total]="getTotalDocsRequeridos()"
            [style.--done]="getUploadedCount()"
          >
            <div class="line-track"></div>
            <div class="line-fill"></div>

            <div
              class="step"
              *ngFor="let _ of [].constructor(getTotalDocsRequeridos()); let i = index"
              [class.done]="i < getUploadedCount()"
            >
              <ion-icon *ngIf="i < getUploadedCount()" name="checkmark"></ion-icon>
            </div>
          </div>

        </div>
      </section>

      <!-- GRID DE DOCUMENTOS -->
      <ion-grid class="docs-grid-ios">
        <ion-row class="docs-row-ios">

          <ng-container *ngFor="let doc of documents">
            <!-- ✅ SOLO FILTRA ACTA CONSTITUTIVA SI NO ES MORAL -->
            <ion-col
              *ngIf="doc.tipo !== 'acta-constitutiva' || tipoPersona === 'moral'"
              size="12" size-sm="6" size-md="4" size-lg="3"
              class="docs-col-ios"
            >
              <ion-card
                class="doc-card-ios"
                [ngClass]="getCardClass(doc)"
                (click)="uploadDocument(doc)"
              >
                <ion-card-header class="doc-card-header">
                  <div class="doc-title-row">

                    <ion-icon
                      [name]="getStatusIcon(doc)"
                      class="doc-icon"
                    ></ion-icon>

                    <div class="doc-title-text">
                      <h2 class="doc-title">{{ doc.name }}</h2>
                      <p class="doc-subtitle">{{ doc.subtitle }}</p>
                    </div>

                  </div>
                </ion-card-header>

                <ion-card-content class="doc-card-body">

                  <!-- ✅ Badge ÚNICO -->
                  <ion-badge
                    class="badge-estado"
                    [ngClass]="{
                      'badge-vacio': !doc.uploaded,
                      'badge-revision': doc.uploaded && (!doc.status || doc.status === 'pendiente'),
                      'badge-aprobado': doc.status === 'aprobado',
                      'badge-rechazado': doc.status === 'rechazado'
                    }"
                  >
                    {{
                      !doc.uploaded ? 'SIN SUBIR' :
                      (doc.status === 'aprobado' ? 'APROBADO' :
                      (doc.status === 'rechazado' ? 'RECHAZADO' : 'EN REVISIÓN'))
                    }}
                  </ion-badge>

                  <!-- Comentario rechazo -->
                  <p
                    *ngIf="doc.status === 'rechazado' && doc.comentarios"
                    class="rechazo-msg"
                  >
                    Motivo: “{{ doc.comentarios }}”
                  </p>

                  <!-- Hint iOS -->
                  <div class="tap-hint">
                    <span>Toca para subir / reemplazar</span>
                    <ion-icon name="chevron-forward-outline"></ion-icon>
                  </div>

                </ion-card-content>
              </ion-card>
            </ion-col>
          </ng-container>

        </ion-row>
      </ion-grid>

      <!-- BOTÓN VOLVER -->
      <div class="volver-wrap">
        <ion-button
          color="danger"
          fill="solid"
          class="btn-back-ios"
          (click)="irAlLote()"
          mode="ios"
        >
          Ir a mi lote “{{ nombreLote }}”
        </ion-button>
      </div>

    </section>

  </div>

  <app-footer></app-footer>
</ion-content>