<app-navbar></app-navbar>

<ion-content [fullscreen]="true">
  <div class="ion-padding">

    <!-- Paso 1: RFC -->
    <div class="ion-margin-bottom" *ngIf="!yaIngresoRFC">

      <ion-card>
        <ion-card-header>
          <ion-card-title class="ion-text-center">
            Validar RFC del Lote
          </ion-card-title>
          <ion-card-subtitle class="ion-text-center">
            Ingresa el RFC para determinar si eres Persona Física o Moral
          </ion-card-subtitle>
        </ion-card-header>

        <ion-card-content>

          <ion-item>
            <ion-label position="floating">RFC del Lote</ion-label>
            <ion-input [(ngModel)]="rfc" (ionInput)="validarRFC()" maxlength="13" clearInput>
            </ion-input>
          </ion-item>

          <p *ngIf="rfcError" style="color:red; margin-top:8px; font-size:14px;">
            {{ rfcError }}
          </p>

          <ion-button expand="block" class="ion-margin-top" color="danger" [disabled]="!rfcValido"
            (click)="enviarRFC()">
            Continuar
          </ion-button>

        </ion-card-content>
      </ion-card>

    </div>

    <!-- Paso 2: Documentos -->
    <div *ngIf="yaIngresoRFC">

      <div class="ion-text-center ion-margin-bottom">
        <ion-text>
          <h1 class="titulo-woaw">Documentación Requerida</h1>

        </ion-text>

        <ion-text color="medium">
          <p>Para completar tu solicitud, necesitamos los siguientes documentos</p>
        </ion-text>

        <ion-card class="progress-steps-card ion-margin-vertical">
          <ion-card-content>

            <div class="steps-head">
              <div class="steps-title">PROGRESO</div>
              <span class="steps-count">{{ getUploadedCount() }}/{{ getTotalDocsRequeridos() }}</span>
              <div class="steps-meta">
                <span class="steps-percent">{{ getProgressPercentage() }}%</span>
              </div>
            </div>

            <!-- ✅ Línea con palomitas -->
            <div class="steps-line" [style.--total]="getTotalDocsRequeridos()" [style.--done]="getUploadedCount()">

              <div class="line-track"></div>
              <div class="line-fill"></div>

              <!-- N bolitas -->
              <div class="step" *ngFor="let _ of [].constructor(getTotalDocsRequeridos()); let i = index"
                [class.done]="i < getUploadedCount()">
                <ion-icon *ngIf="i < getUploadedCount()" name="checkmark"></ion-icon>
              </div>
            </div>

          </ion-card-content>
        </ion-card>

      </div>

      <!-- GRID DE DOCUMENTOS -->
      <ion-grid class="docs-grid ion-margin-bottom">
        <ion-row class="docs-row">

          <ng-container *ngFor="let doc of documents">

            <!-- ✅ SOLO SE FILTRA ACTA CONSTITUTIVA -->
            <ion-col *ngIf="doc.tipo !== 'acta-constitutiva' || tipoPersona === 'moral'" size="12" size-sm="6"
              size-md="4" size-lg="3" class="docs-col">

              <ion-card class="ion-card-document" [ngClass]="getCardClass(doc)" (click)="uploadDocument(doc)">

                <ion-card-header>

                  <ion-card-title class="card-title">
                    <ion-icon [name]="getStatusIcon(doc)" class="icon-status">
                    </ion-icon>
                    <h2 class="ion-text-bold">{{ doc.name }}</h2>
                  </ion-card-title>

                  <ion-card-subtitle>
                    {{ doc.subtitle }}
                  </ion-card-subtitle>

                </ion-card-header>

                <ion-card-content>

                  <!-- Badge de subida -->
                  <!-- ✅ Badge ÚNICO (sin confusión) -->
                  <ion-badge class="badge-estado" [ngClass]="{
                    'badge-vacio': !doc.uploaded,
                    'badge-revision': doc.uploaded && (!doc.status || doc.status === 'pendiente'),
                    'badge-aprobado': doc.status === 'aprobado',
                    'badge-rechazado': doc.status === 'rechazado'
                  }">
                    {{
                    !doc.uploaded ? 'SIN SUBIR' :
                    (doc.status === 'aprobado' ? 'APROBADO' :
                    (doc.status === 'rechazado' ? 'RECHAZADO' : 'EN REVISIÓN'))
                    }}
                  </ion-badge>

                  <!-- Comentario rechazo -->
                  <p *ngIf="doc.status === 'rechazado' && doc.comentarios" class="comentario-rechazo">
                    Motivo: "{{ doc.comentarios }}"
                  </p>

                </ion-card-content>

              </ion-card>

            </ion-col>

          </ng-container>

        </ion-row>
      </ion-grid>

      <!-- Botón volver -->
      <div class="volver-container">
        <ion-button fill="outline" class="btn-volver" (click)="irAlLote()">
          IR A MI LOTE "{{ nombreLote }}"
        </ion-button>
      </div>


    </div>

  </div>

  <app-footer></app-footer>
</ion-content>