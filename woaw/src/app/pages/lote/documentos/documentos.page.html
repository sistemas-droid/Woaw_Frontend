<app-navbar></app-navbar>

<ion-content [fullscreen]="true">
  <div class="ion-padding">

    <!-- Paso 1: RFC -->
    <div class="ion-margin-bottom" *ngIf="!yaIngresoRFC">

      <ion-card>
        <ion-card-header>
          <ion-card-title class="ion-text-center">
            Validar RFC del Lote
          </ion-card-title>
          <ion-card-subtitle class="ion-text-center">
            Ingresa el RFC para determinar si eres Persona Física o Moral
          </ion-card-subtitle>
        </ion-card-header>

        <ion-card-content>

          <ion-item>
            <ion-label position="floating">RFC del Lote</ion-label>
            <ion-input [(ngModel)]="rfc" (ionInput)="validarRFC()" maxlength="13" clearInput>
            </ion-input>
          </ion-item>

          <p *ngIf="rfcError" style="color:red; margin-top:8px; font-size:14px;">
            {{ rfcError }}
          </p>

          <ion-button expand="block" class="ion-margin-top" color="danger" [disabled]="!rfcValido"
            (click)="enviarRFC()">
            Continuar
          </ion-button>

        </ion-card-content>
      </ion-card>

    </div>

    <!-- Paso 2: Documentos -->
    <div *ngIf="yaIngresoRFC">

      <div class="ion-text-center ion-margin-bottom">
        <ion-text>
          <h1 class="ion-text-bold">Documentación Requerida</h1>
        </ion-text>

        <ion-text color="medium">
          <p>Para completar tu solicitud, necesitamos los siguientes documentos</p>
        </ion-text>

        <ion-card class="ion-margin-vertical">
          <ion-card-content>

            <div class="ion-text-center ion-margin-bottom">
              <ion-text>
                <p class="ion-text-bold">
                  Progreso: {{ getUploadedCount() }}/{{ getTotalDocsRequeridos() }}
                </p>
              </ion-text>

              <ion-text color="danger">
                <p class="ion-text-bold">{{ getProgressPercentage() }}%</p>
              </ion-text>
            </div>

            <ion-progress-bar [value]="getProgressPercentage() / 100" color="danger">
            </ion-progress-bar>

          </ion-card-content>
        </ion-card>
      </div>

      <!-- GRID DE DOCUMENTOS CENTRADO -->
      <ion-grid class="docs-grid ion-margin-bottom">
        <ion-row class="docs-row">

          <ng-container *ngFor="let doc of documents">

            <!-- PF no ve acta constitutiva -->
            <ion-col *ngIf="!(doc.tipo === 'acta-constitutiva' && tipoPersona !== 'moral')" size="12" size-sm="6"
              size-md="4" size-lg="3" class="docs-col">

              <ion-card class="ion-card-document" [ngClass]="getCardClass(doc)" (click)="uploadDocument(doc)">

                <ion-card-header>

                  <ion-card-title class="card-title">
                    <ion-icon [name]="getStatusIcon(doc)" class="icon-status"></ion-icon>
                    <ion-text>
                      <h2 class="ion-text-bold">{{ doc.name }}</h2>
                    </ion-text>
                  </ion-card-title>

                  <!-- PF / PM -->
                  <ion-card-subtitle *ngIf="doc.tipo === 'formatos-autorizacion'">
                    <span *ngIf="tipoPersona === 'fisica'">Persona Física</span>
                    <span *ngIf="tipoPersona === 'moral'">Persona Moral</span>
                    <span *ngIf="!tipoPersona">Personas Físicas / Morales</span>
                  </ion-card-subtitle>

                  <!-- Normal -->
                  <ion-card-subtitle *ngIf="doc.tipo !== 'formatos-autorizacion'">
                    {{ doc.subtitle }}
                  </ion-card-subtitle>

                </ion-card-header>

                <ion-card-content>

                  <!-- Badge de subida -->
                  <ion-badge [color]="doc.uploaded ? 'success' : 'warning'" class="ion-margin-top">
                    {{ doc.uploaded ? 'Completado' : 'Pendiente' }}
                  </ion-badge>

                  <!-- Badge Premium de estado -->
                  <ion-badge *ngIf="doc.status" [color]="
                      doc.status === 'aprobado' ? 'success' :
                      doc.status === 'rechazado' ? 'danger' : 'warning'
                    " class="badge-status">
                    {{ doc.status | titlecase }}
                  </ion-badge>

                  <!-- Comentario si fue rechazado -->
                  <p *ngIf="doc.status === 'rechazado' && doc.comentarios" class="comentario-rechazo">
                    Motivo: "{{ doc.comentarios }}"
                  </p>

                </ion-card-content>

              </ion-card>

            </ion-col>

          </ng-container>

        </ion-row>
      </ion-grid>

      <!-- Botón volver -->
      <div class="volver-container">
        <ion-button color="danger" fill="solid" class="btn-volver" (click)="irAlLote()">
          ir a mi lote "{{ nombreLote }}"
        </ion-button>
      </div>

    </div>

  </div>

  <app-footer></app-footer>
</ion-content>