<app-navbar></app-navbar>

<ion-content [fullscreen]="true" class="mis-reservas">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- ðŸ”¹ ENCABEZADO -->
  <div class="page-head">
    <h1>Mis reservas</h1>
    <p class="sub">
      Historial y acciones rÃ¡pidas.
      <span *ngIf="!loading">Total: {{ datos.length || 0 }}</span>
    </p>
    <div class="quick-chips">
      <ion-chip color="danger" outline="true">
        <ion-icon name="alert-circle-outline"></ion-icon>
        <ion-label>Pendientes: {{ pendingOwner.length || 0 }}</ion-label>
      </ion-chip>
      <ion-chip color="success" outline="true" *ngIf="!loading && datos?.length">
        <ion-icon name="checkmark-circle-outline"></ion-icon>
        <ion-label>Registradas</ion-label>
      </ion-chip>
    </div>
  </div>

  <!-- ðŸ”„ PLACEHOLDER DE CARGA -->
  <ion-list *ngIf="loading">
    <ion-item *ngFor="let i of [1, 2, 3, 4]">
      <ion-skeleton-text animated style="width: 100%; height: 86px"></ion-skeleton-text>
    </ion-item>
  </ion-list>

  <!-- ðŸš— SOLICITUDES DE RESERVA (PROPIETARIO) -->
  <h2 class="section-title" *ngIf="loadingPending || pendingOwner.length > 0">
    Solicitudes de reserva
  </h2>

  <ion-card *ngIf="loadingPending || pendingOwner.length > 0" class="solicitud-card">
    <ion-card-header>
      <ion-card-title>Solicitudes de reserva (tus coches)</ion-card-title>
      <ion-card-subtitle *ngIf="!loadingPending">
        {{ pendingOwner.length }} pendiente(s)
      </ion-card-subtitle>
    </ion-card-header>

    <ion-card-content>
      <!-- ðŸŒ€ Cargando solicitudes -->
      <ion-list *ngIf="loadingPending">
        <ion-item *ngFor="let s of [1, 2, 3]">
          <ion-skeleton-text animated style="width: 60%"></ion-skeleton-text>
        </ion-item>
      </ion-list>

      <!-- âœ… Sin solicitudes -->
      <ion-item *ngIf="!loadingPending && pendingOwner.length === 0" lines="none">
        <ion-icon name="checkmark-circle-outline" slot="start" color="success"></ion-icon>
        <ion-label>Sin solicitudes pendientes por ahora.</ion-label>
      </ion-item>

      <!-- ðŸ“‹ Lista de solicitudes -->
      <ion-list *ngIf="!loadingPending && pendingOwner.length > 0">
        <ion-card *ngFor="let b of pendingOwner" class="solicitud-item">
          <div class="solicitud-layout">
            <!-- ðŸ–¼ï¸ Imagen -->
            <div class="solicitud-img" *ngIf="b?._imgUrl">
              <img [src]="b._imgUrl" alt="VehÃ­culo solicitado" />
            </div>

            <!-- â„¹ï¸ InformaciÃ³n -->
            <div class="solicitud-info">
              <h3 class="nombre-usuario">
                {{ displayUsuario(b?.usuario) }}
                <ion-note color="medium"> â€¢ {{ b?.moneda || 'MXN' }} {{ b?.total | number:'1.0-0' }}</ion-note>
              </h3>

              <p class="auto-detalle">
                <ion-icon name="car-outline"></ion-icon>
                {{ b?._car?.marca }} {{ b?._car?.modelo }}
              </p>

              <p class="rango-fechas">
                <ion-icon name="calendar-outline"></ion-icon>
                {{ b?.fechaInicio | date:'mediumDate' }} â†’ {{ b?.fechaFin | date:'mediumDate' }}
                <ion-note color="medium"> ({{ b?.dias }} dÃ­a(s))</ion-note>
              </p>

              <p *ngIf="b?.notasCliente" class="nota-cliente ion-text-wrap">
                <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
                {{ b?.notasCliente }}
              </p>
            </div>

            <!-- ðŸ”˜ Acciones -->
            <div class="solicitud-acciones">
              <ion-button size="small" color="success" (click)="acceptPending(b)" [disabled]="actingIds.has(b._id)">
                <ion-spinner *ngIf="actingIds.has(b._id) && actingAction==='accept'" name="crescent"></ion-spinner>
                <span *ngIf="!(actingIds.has(b._id) && actingAction==='accept')">Aceptar</span>
              </ion-button>

              <ion-button size="small" color="danger" fill="outline" (click)="cancelar(b)"
                [disabled]="actingIds.has(b._id)">
                <ion-spinner *ngIf="actingIds.has(b._id) && actingAction==='cancel'" name="crescent"></ion-spinner>
                <span *ngIf="!(actingIds.has(b._id) && actingAction==='cancel')">Cancelar</span>
              </ion-button>
            </div>
          </div>
        </ion-card>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <!-- âŒ ESTADO VACÃO -->
  <div *ngIf="!loading && datos.length === 0" class="vacio">
    <ion-icon name="car-outline"></ion-icon>
    <p>No hay reservas registradas.</p>
  </div>

  <!-- ðŸ“¦ LISTA DE RESERVAS -->
  <h2 class="section-title" *ngIf="!loading && datos.length">Tus reservas</h2>

  <ion-list *ngIf="!loading && datos.length">
    <ion-card class="booking-card" *ngFor="let b of datos; trackBy: trackByBooking" [attr.data-status]="b.estatus">
      <div class="booking-layout">
        <!-- ðŸ“¸ Imagen -->
        <div class="booking-img" *ngIf="b?._imgUrl">
          <img [src]="b._imgUrl" alt="Imagen del coche" loading="lazy" />
        </div>

        <!-- ðŸ”¹ Bloque derecho -->
        <div class="booking-info-block">
          <!-- ðŸ§© Header -->
          <div class="booking-header-row">
            <ion-card-title class="truncate">
              {{ b._car?.marca }} {{ b._car?.modelo }}
            </ion-card-title>
            <ion-badge [color]="colorEstatus(b.estatus)">{{ b.estatus }}</ion-badge>
          </div>

          <!-- ðŸ“‹ Detalles -->
          <div class="booking-details-row">
            <div class="booking-info">
              <ion-card-subtitle class="reserva-code">
                <ion-icon name="key-outline"></ion-icon>
                Reserva #{{ b.codigo || b._id }}
              </ion-card-subtitle>

              <ion-card-subtitle class="dates">
                <ion-icon name="calendar-outline"></ion-icon>
                {{ b.fechaInicio | date:'medium' }} â†’ {{ b.fechaFin | date:'medium' }}
              </ion-card-subtitle>
            </div>

            <div class="booking-price">
              <small>Total</small>
              <div class="amount">
                <ion-icon name="cash-outline"></ion-icon>
                <strong>{{ b.total | number:'1.0-0' }}</strong>
                <span class="currency">{{ b.moneda || 'MXN' }}</span>
              </div>
            </div>

            <div class="booking-actions">
              <ion-button *ngIf="puedeCancelar(b)" color="danger" fill="outline" (click)="cancelar(b)"
                [disabled]="actingIds.has(b._id)">
                <ion-spinner *ngIf="actingIds.has(b._id) && actingAction==='cancel'" name="crescent"></ion-spinner>
                <span *ngIf="!(actingIds.has(b._id) && actingAction==='cancel')">Cancelar</span>
              </ion-button>

              <ion-button color="danger" fill="solid" (click)="irAccion(b)">
                <ng-container *ngIf="soyPropietarioDeAuto(b); else noOwner">
                  <ng-container *ngIf="b.estatus === 'aceptada'">Check-In</ng-container>
                  <ng-container *ngIf="b.estatus === 'en_curso'">Check-Out</ng-container>
                  <ng-container *ngIf="b.estatus === 'finalizada'">Ver</ng-container>
                </ng-container>
                <ng-template #noOwner>Ver</ng-template>
              </ion-button>

              <ion-button color="medium" fill="outline" (click)="openDetalle(b)">Detalle</ion-button>
            </div>
          </div>
        </div>
      </div>
    </ion-card>
  </ion-list>

  <!-- ðŸ” INFINITE SCROLL -->
  <h2 class="section-title" *ngIf="hasMore && !loading">MÃ¡s resultados</h2>

  <ion-infinite-scroll *ngIf="hasMore" threshold="100px" (ionInfinite)="cargarMas($event)">
    <ion-infinite-scroll-content loadingSpinner="bubbles" loadingText="Cargando mÃ¡s..."></ion-infinite-scroll-content>
  </ion-infinite-scroll>

  <app-footer></app-footer>
</ion-content>