<ion-header class="ios-header">
  <ion-toolbar class="ios-toolbar" mode="ios">
    <ion-buttons slot="start">
      <ion-button fill="clear" class="ios-back" (click)="regresar()" aria-label="Regresar">
        <ion-icon slot="icon-only" name="chevron-back"></ion-icon>
      </ion-button>
    </ion-buttons>

    <div class="ios-title-wrap" *ngIf="renta">
      <img src="/assets/icon/logo4.png" alt="Go Autos" class="logo-mini" />
      <div class="ios-title-stack">
        <h1 class="ios-title">
          {{ renta?.marca }} {{ renta?.modelo }}
        </h1>
        <p class="ios-subtitle">Condiciones de renta</p>
      </div>
    </div>

    <ion-buttons slot="end">
      <ion-button fill="clear" class="ios-close" (click)="regresar()" aria-label="Cerrar">
        <ion-icon slot="icon-only" name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content mode="ios" [fullscreen]="true" class="rent-content">
  <div class="contenedor">
    <!-- Datos del veh√≠culo -->
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="3">
          <ion-item>
            <ion-label position="stacked">Tipo de veh√≠culo</ion-label>
            <ion-select [(ngModel)]="renta.tipoVehiculo" (ionChange)="markDirty()">
              <ion-select-option value="">Seleccione‚Ä¶</ion-select-option>
              <ion-select-option value="sedan">sedan</ion-select-option>
              <ion-select-option value="suv">suv</ion-select-option>
              <ion-select-option value="pickup">pickup</ion-select-option>
              <ion-select-option value="van">van</ion-select-option>
              <ion-select-option value="hatchback">hatchback</ion-select-option>
              <ion-select-option value="otro">otro</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="3">
          <ion-item>
            <ion-label position="stacked">Transmisi√≥n</ion-label>
            <ion-select [(ngModel)]="renta.transmision" (ionChange)="markDirty()">
              <ion-select-option value="">Seleccione‚Ä¶</ion-select-option>
              <ion-select-option value="manual">manual</ion-select-option>
              <ion-select-option value="autom√°tica">autom√°tica</ion-select-option>
              <ion-select-option value="CVT">CVT</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="3">
          <ion-item>
            <ion-label position="stacked">Combustible</ion-label>
            <ion-select [(ngModel)]="renta.combustible" (ionChange)="markDirty()">
              <ion-select-option value="">Seleccione‚Ä¶</ion-select-option>
              <ion-select-option value="gasolina">gasolina</ion-select-option>
              <ion-select-option value="diesel">diesel</ion-select-option>
              <ion-select-option value="h√≠brido">h√≠brido</ion-select-option>
              <ion-select-option value="el√©ctrico">el√©ctrico</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="3">
          <ion-item>
            <ion-label position="stacked">Pasajeros</ion-label>
            <ion-input
              type="number"
              min="1"
              [(ngModel)]="renta.pasajeros"
              (ionInput)="markDirty()"
              placeholder="Ej. 5">
            </ion-input>
          </ion-item>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Precio -->
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">
              Precio por d√≠a <span class="req">*</span>
            </ion-label>
            <ion-input
              type="number"
              min="500"
              [(ngModel)]="renta.precioPorDia"
              (ionInput)="markDirty()">
            </ion-input>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">Moneda</ion-label>
            <ion-select [(ngModel)]="renta.moneda" (ionChange)="markDirty()">
              <ion-select-option value="MXN">MXN</ion-select-option>
              <ion-select-option value="USD">USD</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Pol√≠ticas -->
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">Pol√≠tica combustible</ion-label>
            <ion-select [(ngModel)]="renta.politicaCombustible" (ionChange)="markDirty()">
              <ion-select-option value="lleno-lleno">lleno-lleno</ion-select-option>
              <ion-select-option value="como-esta">como-esta</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">Pol√≠tica limpieza</ion-label>
            <ion-select [(ngModel)]="renta.politicaLimpieza" (ionChange)="markDirty()">
              <ion-select-option value="normal">normal</ion-select-option>
              <ion-select-option value="estricta">estricta</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">Edad m√≠nima</ion-label>
            <ion-input
              type="number"
              min="18"
              [(ngModel)]="renta.requisitosConductor.edadMinima"
              (ionInput)="markDirty()">
            </ion-input>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">Antig√ºedad licencia (meses)</ion-label>
            <ion-input
              type="number"
              min="0"
              [(ngModel)]="renta.requisitosConductor.antiguedadLicenciaMeses"
              (ionInput)="markDirty()">
            </ion-input>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">Conductor adicional</ion-label>
            <ion-select
              [(ngModel)]="renta.requisitosConductor.permiteConductorAdicional"
              (ionChange)="markDirty()">
              <ion-select-option [value]="false">No</ion-select-option>
              <ion-select-option [value]="true">S√≠</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <ion-col
          size="12"
          size-md="6"
          *ngIf="renta.requisitosConductor.permiteConductorAdicional">
          <ion-item>
            <ion-label position="stacked">Costo conductor adicional</ion-label>
            <ion-input
              type="number"
              min="0"
              [(ngModel)]="renta.requisitosConductor.costoConductorAdicional"
              (ionInput)="markDirty()">
            </ion-input>
          </ion-item>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Entrega -->
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">Entrega gratis hasta (km)</ion-label>
            <ion-input
              type="number"
              min="0"
              [(ngModel)]="renta.entrega.gratuitoHastaKm"
              (ionInput)="onGratisHastaChange()">
            </ion-input>
          </ion-item>
        </ion-col>

        <ion-col size="12">
          <div class="tarifas">
            <div class="tarifas__header">
              <label class="tarifas__title">Tarifas por distancia</label>
              <button
                type="button"
                class="btn btn-soft btn-sm"
                (click)="addTarifa()">
                + Agregar tarifa
              </button>
            </div>
            <p class="hint">Agrega al menos una tarifa o especifica ‚ÄúEntrega gratis hasta (km)‚Äù.</p>

            <div
              class="tarifa-card"
              *ngFor="let t of renta.entrega.tarifasPorDistancia; let i = index">
              <div class="tarifa-card__top">
                <h5 class="tarifa-card__title">Tarifa {{ i + 1 }}</h5>
                <button
                  type="button"
                  class="btn btn-danger btn-sm"
                  (click)="removeTarifa(i)">
                  <ion-icon name="trash-outline"></ion-icon>
                  Quitar
                </button>
              </div>

              <div class="tarifa-card__grid">
                <div class="campo">
                  <label>Desde (km)</label>
                  <input
                    type="number"
                    min="0"
                    [(ngModel)]="t.desdeKm"
                    [readonly]="i === 0 ? (+renta.entrega.gratuitoHastaKm) > 0 : true"
                    placeholder="0" />
                </div>

                <div class="campo">
                  <label>Hasta (km)</label>
                  <input
                    type="number"
                    min="0"
                    [(ngModel)]="t.hastaKm"
                    (ngModelChange)="onTarifaHastaChange(i)" />
                </div>

                <div class="campo">
                  <label>Costo fijo</label>
                  <input
                    type="number"
                    min="0"
                    step="0.01"
                    [(ngModel)]="t.costoFijo" />
                </div>

                <div class="campo full">
                  <label>Nota (opcional)</label>
                  <input
                    type="text"
                    [(ngModel)]="t.nota"
                    placeholder="Ej. Zona centro" />
                </div>
              </div>
            </div>
          </div>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- üîπ Tipo de publicaci√≥n -->
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6">
          <ion-item lines="none" class="item-segment">
            <ion-label position="stacked">Tipo de publicaci√≥n</ion-label>
            <ion-segment
              mode="ios"
              [(ngModel)]="tipoSeleccionado"
              (ionChange)="toggleTipoPublicacion()">
              <ion-segment-button value="particular">
                <ion-label>Particular</ion-label>
              </ion-segment-button>
              <ion-segment-button value="lote">
                <ion-label>Lote</ion-label>
              </ion-segment-button>
            </ion-segment>
          </ion-item>
        </ion-col>
      </ion-row>

      <!-- üî∏ Bloque de selecci√≥n de lote -->
      <ion-row *ngIf="tipoSeleccionado === 'lote'">
        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">Selecciona un lote</ion-label>
            <ion-select
              [(ngModel)]="loteSeleccionado"
              interface="action-sheet"
              (ionChange)="onLoteSeleccionado()">
              <ion-select-option
                *ngFor="let lote of lotes"
                [value]="lote._id">
                {{ lote.nombre }}
              </ion-select-option>
            </ion-select>
          </ion-item>

          <div
            *ngIf="(ubicacionesSeleccionadas?.length || 0) > 0"
            class="bloque-direcciones">
            <ion-list class="ubicaciones-checkbox-list">
              <ion-item
                *ngFor="let dir of ubicacionesSeleccionadas; let i = index">
                <ion-checkbox
                  slot="start"
                  [checked]="isUbicacionSeleccionada(dir)"
                  (ionChange)="toggleUbicacionLote(dir, $event)">
                </ion-checkbox>
                <ion-label>
                  <p>
                    {{ dir.direccionCompleta || (dir.ciudad + ', ' + dir.estado) }}
                  </p>
                </ion-label>
              </ion-item>
            </ion-list>
          </div>
        </ion-col>
      </ion-row>

      <!-- üî∏ Ubicaciones m√∫ltiples -->
      <ion-row *ngIf="tipoSeleccionado === 'particular'">
        <ion-col size="12" size-md="6">
          <ion-button
            expand="block"
            color="danger"
            (click)="seleccionarUbicacion()">
            <ion-icon name="location-outline" slot="start"></ion-icon>
            Agregar ubicaci√≥n
          </ion-button>

          <div
            *ngIf="ubicacionesSeleccionadas.length > 0"
            class="ubicaciones-list">
            <ion-list>
              <ion-item
                *ngFor="let ubic of ubicacionesSeleccionadas; let i = index"
                class="ubicacion-item">
                <ion-icon name="location-outline" slot="start"></ion-icon>
                <ion-label>
                  <p>{{ ubic.direccionCompleta }}</p>
                </ion-label>
                <ion-button
                  fill="clear"
                  color="danger"
                  slot="end"
                  (click)="eliminarUbicacion(i)">
                  <ion-icon name="close-circle"></ion-icon>
                </ion-button>
              </ion-item>
            </ion-list>
          </div>

          <div
            *ngIf="ubicacionesSeleccionadas.length === 0"
            class="ubicacion-mostrada">
            <ion-icon name="location-outline"></ion-icon>
            <span>Selecciona al menos una ubicaci√≥n</span>
          </div>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Im√°genes -->
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Imagen principal</ion-card-title>
              <ion-card-subtitle>Selecciona una imagen para el listado</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <div class="botons">
                <button class="button-nuevo" (click)="seleccionarImagen()">
                  <ion-icon name="add-outline"></ion-icon>
                  Nueva imagen
                </button>
                <input
                  type="file"
                  accept="image/*"
                  hidden
                  #inputArchivo
                  (change)="cargarNuevaImagen($event)" />
              </div>

              <div class="contenedor-imagen">
                <img
                  [src]="imagenPrincipalMostrada || '/assets/default-car.webp'"
                  alt="Imagen principal" />
              </div>

              <div class="galeria-scroll" *ngIf="urlsImagenes?.length">
                <img
                  *ngFor="let img of urlsImagenes"
                  [src]="img"
                  alt="Imagen"
                  (click)="actualizarImagenPrincipal(img)" />
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Im√°genes adicionales</ion-card-title>
              <ion-card-subtitle>Agrega m√°ximo 10 im√°genes</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <label class="btn-agregar">
                <ion-icon name="add-outline"></ion-icon>
                Agregar imagen
                <input
                  type="file"
                  accept="image/*"
                  (change)="agregarImagen($event)"
                  hidden />
              </label>

              <div class="galeria-scroll-big" *ngIf="urlsImagenes?.length">
                <div class="img-wrapper" *ngFor="let img of urlsImagenes">
                  <img [src]="img" alt="Imagen" />
                  <div class="overlay-botones">
                    <button
                      class="btn-accion eliminar"
                      (click)="eliminarImagen_visual(img)">
                      <ion-icon name="trash-outline"></ion-icon>
                      Eliminar
                    </button>
                  </div>
                </div>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Botones -->
    <div class="action-bar">
      <div class="action-buttons">
        <ion-button fill="clear" color="medium" (click)="regresar()">
          <ion-icon name="close-outline"></ion-icon>
          <span>Cancelar</span>
        </ion-button>

        <ion-button
          fill="outline"
          color="warning"
          (click)="onRestablecerClick()"
          [disabled]="!dirty">
          <ion-icon name="refresh-outline"></ion-icon>
          <span>Restablecer</span>
        </ion-button>

        <ion-button
          color="success"
          (click)="onGuardarClick()"
          [disabled]="!dirty">
          <ion-icon name="save-outline"></ion-icon>
          <span>Guardar</span>
        </ion-button>
      </div>
    </div>
  </div>

  <app-footer></app-footer>
</ion-content>
